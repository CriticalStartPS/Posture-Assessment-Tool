import subprocess
import json
import yaml
import os
import tempfile
from typing import Dict, List, Any
from .ExchangeOnlineSessionManager import ExchangeOnlineSessionManager

class AntiMalwarePolicyHandler:
    def __init__(self, requirements_file: str = None, session_manager: ExchangeOnlineSessionManager = None):
        self.requirements = None
        
        # Use provided session manager or create a new one
        self.session_manager = session_manager if session_manager else ExchangeOnlineSessionManager()
        
        if requirements_file and os.path.exists(requirements_file):
            with open(requirements_file, 'r') as file:
                self.requirements = yaml.safe_load(file)

    def check_policies(self) -> List[Dict[str, Any]]:
        """Check anti-malware policies against requirements using shared session manager"""
        all_results = []
        
        print("\n=== Starting Defender for Office 365 Anti-Malware Policy Check ===")
        
        if not self.requirements:
            print("No anti-malware requirements file provided")
            return [{
                'requirement_name': 'No Requirements',
                'found': False,
                'status': 'MISSING - No anti-malware requirements file provided',
                'policy_type': 'antimalware'
            }]
        
        print("Retrieving anti-malware policies using shared session manager")
        
        # Use shared session manager to get anti-malware policies
        all_policies = self.session_manager.get_all_defender_policies(['antimalware'])
        
        antimalware_policies = all_policies.get("antimalware", [])
        
        print(f"Retrieved {len(antimalware_policies)} anti-malware policies")
        
        # Check anti-malware policies against requirements
        print("\n--- Checking Anti-Malware Policies ---")
        antimalware_results = self._check_policy_requirements(antimalware_policies, self.requirements, "antimalware")
        all_results.extend(antimalware_results)
        
        return all_results

    def _check_policy_requirements(self, policies: List[Dict], requirements: Dict, policy_type: str) -> List[Dict[str, Any]]:
        """Check policies against requirements for anti-malware policies"""
        results = []
        
        if not policies:
            return [{
                'requirement_name': f'{policy_type.title()} Connection Error',
                'found': False,
                'status': f'MISSING - Could not connect to Exchange Online or retrieve {policy_type} policies',
                'policy_type': policy_type
            }]
        
        print(f"Successfully retrieved {len(policies)} {policy_type} policies")
        
        # Filter to only enabled policies (policies that are actually in use)
        enabled_policies = []
        for policy in policies:
            # Include default policies and enabled custom policies
            if (policy.get('IsDefault', False) or 
                policy.get('IsValid', True)):  # IsValid typically indicates the policy is enabled
                enabled_policies.append(policy)
                print(f"  - {policy_type.title()} Policy: {policy.get('Name', 'Unknown')} (Default: {policy.get('IsDefault', False)})")
        
        if not enabled_policies:
            enabled_policies = policies  # Fallback to all policies if none marked as enabled
            print(f"No enabled {policy_type} policies found via IsDefault/IsValid, evaluating all policies")
        
        print(f"Evaluating {len(enabled_policies)} enabled {policy_type} policies")
        
        # Get the appropriate requirements key
        requirements_key = f'{policy_type}_policies'
        policy_requirements = requirements.get(requirements_key, [])
        
        # Evaluate each requirement against ALL enabled policies
        for requirement in policy_requirements:
            setting = requirement['setting']
            expected_value = requirement['expected_value']
            requirement_name = requirement['name']
            
            # Track results for this requirement across all policies
            policy_results = []
            compliant_policies = []
            non_compliant_policies = []
            
            for policy in enabled_policies:
                policy_name = policy.get('Name', 'Unknown')
                current_value = policy.get(setting)
                
                # Determine compliance for this policy
                is_compliant = False
                if isinstance(expected_value, bool):
                    current_bool = bool(current_value) if current_value is not None else False
                    is_compliant = current_bool == expected_value
                elif isinstance(expected_value, str):
                    is_compliant = current_value == expected_value
                elif isinstance(expected_value, dict) and expected_value.get('comparison_type') == 'contains_all':
                    # Handle contains_all comparison type
                    required_items = expected_value.get('required_items', [])
                    if isinstance(current_value, list) and isinstance(required_items, list):
                        # Check if all required items are present (case-insensitive)
                        current_items_lower = [item.lower() for item in current_value] if current_value else []
                        required_items_lower = [item.lower() for item in required_items]
                        missing_items = [item for item in required_items_lower if item not in current_items_lower]
                        is_compliant = len(missing_items) == 0
                        
                        # Store additional info for debugging
                        if not is_compliant:
                            policy_result['missing_items'] = missing_items
                            policy_result['found_items'] = len(current_items_lower)
                            policy_result['required_items'] = len(required_items_lower)
                    else:
                        is_compliant = False
                elif isinstance(expected_value, list):
                    # Legacy list comparison (exact match)
                    if setting == "FileTypes" and isinstance(current_value, list):
                        # Check if all expected file types are present (case-insensitive)
                        current_types_lower = [ft.lower() for ft in current_value] if current_value else []
                        expected_types_lower = [ft.lower() for ft in expected_value]
                        missing_types = [ft for ft in expected_types_lower if ft not in current_types_lower]
                        is_compliant = len(missing_types) == 0
                    else:
                        is_compliant = current_value == expected_value
                else:
                    is_compliant = current_value == expected_value
                
                # Store result for this policy
                policy_result = {
                    'policy_name': policy_name,
                    'current_value': current_value,
                    'is_compliant': is_compliant
                }
                policy_results.append(policy_result)
                
                if is_compliant:
                    compliant_policies.append(policy_name)
                else:
                    non_compliant_policies.append(f"{policy_name} (Current: {current_value})")
            
            # Determine overall compliance for this requirement
            # At least one policy must be compliant for the requirement to pass
            overall_compliant = len(compliant_policies) > 0
            
            # Create result entry
            if overall_compliant:
                status = f"COMPLIANT - Found in policies: {', '.join(compliant_policies)}"
            else:
                status = f"NON-COMPLIANT - All policies failed: {', '.join(non_compliant_policies)}"
            
            # For display purposes, show the actual expected value format
            display_expected_value = expected_value
            if isinstance(expected_value, dict) and expected_value.get('comparison_type') == 'contains_all':
                display_expected_value = f"Contains all: {expected_value.get('required_items', [])}"
            
            result = {
                'requirement_name': requirement_name,
                'setting': setting,
                'expected_value': display_expected_value,
                'found': overall_compliant,
                'status': status,
                'policy_type': policy_type,
                'policy_results': policy_results
            }
            
            results.append(result)
            
            # Print detailed results
            if overall_compliant:
                print(f"  ✓ {requirement_name}: COMPLIANT")
                print(f"    Compliant policies: {', '.join(compliant_policies)}")
            else:
                print(f"  ✗ {requirement_name}: NON-COMPLIANT")
                if isinstance(expected_value, dict) and expected_value.get('comparison_type') == 'contains_all':
                    print(f"    Expected: Contains all {len(expected_value.get('required_items', []))} required items")
                    print(f"    Required items: {expected_value.get('required_items', [])}")
                else:
                    print(f"    Expected: {expected_value}")
                for policy_result in policy_results:
                    compliance_symbol = '✓' if policy_result['is_compliant'] else '✗'
                    if 'missing_items' in policy_result:
                        print(f"    {policy_result['policy_name']}: {policy_result['found_items']}/{policy_result['required_items']} items found ({compliance_symbol})")
                        if policy_result['missing_items']:
                            print(f"      Missing: {policy_result['missing_items']}")
                    else:
                        print(f"    {policy_result['policy_name']}: {policy_result['current_value']} ({compliance_symbol})")
        
        return results

    def get_requirements_summary(self) -> Dict[str, Any]:
        """Get a summary of loaded requirements"""
        if not self.requirements:
            return {'loaded': False, 'requirements_count': 0}
        
        antimalware_count = len(self.requirements.get('antimalware_policies', []))
        
        return {
            'loaded': True,
            'requirements_count': antimalware_count,
            'antimalware_policies': antimalware_count
        }
