<!DOCTYPE html>
<html>
<head>
    <title>Posture Assessment Tool Report</title>
    <style>
        @import url(https://fonts.googleapis.com/css?family=Nunito+Sans);
        @import url(https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap);
        
        :root {
            /* CriticalStart Theme Colors */
            --primary-color: #009cde;
            --primary-dark: #0c4c70;
            --background-dark: #141827;
            --surface-dark: #1b2032;
            --surface-light: #2a2f45;
            --border-color: #4e586a;
            --text-white: #fff;
            --text-light: #d1d1d1;
            
            /* Status Colors from CriticalStart CSS */
            --success-color: #28a745;
            --warning-color: #ffc107;
            --warning-text: #000;
            --danger-color: #dc3545;
            --info-color: #6f42c1;
            --orange-color: #fd7e14;
        }
        
        body {
            font-family: 'Nunito Sans', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-dark);
            color: var(--text-white);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-color) 100%);
            color: var(--text-white);
            padding: 30px 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .header h1 {
            margin: 0;
            font-size: 32px;
            font-weight: 600;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .timestamp {
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
            margin-top: 10px;
        }
        
        .tenant-info {
            color: rgba(255, 255, 255, 0.95);
            font-size: 16px;
            margin: 15px 0 10px 0;
            padding: 10px 0;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .summary-card {
            background: var(--surface-dark);
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
        }
        
        .summary-card h2 {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 24px;
            font-weight: 600;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-item {
            background: var(--surface-light);
            padding: 20px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid var(--border-color);
            transition: transform 0.2s ease;
        }
        
        .stat-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }
        
        .stat-number {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 5px;
            font-family: 'Roboto Mono', monospace;
        }
        
        .stat-number.compliant {
            color: var(--success-color);
        }
        
        .stat-number.non-compliant {
            color: var(--danger-color);
        }
        
        .stat-number.total {
            color: var(--primary-color);
        }
        
        .stat-label {
            font-size: 14px;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .compliance-bar {
            width: 100%;
            height: 20px;
            background: var(--surface-light);
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
            border: 1px solid var(--border-color);
        }
        
        .compliance-fill {
            height: 100%;
            transition: width 0.3s ease;
            background: linear-gradient(90deg, var(--success-color) 0%, var(--primary-color) 100%);
        }
        
        .section-card {
            background: var(--surface-dark);
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }
        
        .section-header {
            background: var(--surface-light);
            padding: 20px 25px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .section-header h3 {
            margin: 0;
            color: var(--primary-color);
            font-size: 20px;
            font-weight: 600;
        }
        
        .section-content {
            padding: 25px;
        }
        
        .policy-item {
            background: var(--surface-light);
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid var(--border-color);
            transition: all 0.2s ease;
        }
        
        .policy-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .policy-item.pass {
            border-left-color: var(--success-color);
            background: linear-gradient(135deg, var(--surface-light) 0%, rgba(40, 167, 69, 0.1) 100%);
        }
        
        .policy-item.fail {
            border-left-color: var(--danger-color);
            background: linear-gradient(135deg, var(--surface-light) 0%, rgba(220, 53, 69, 0.1) 100%);
        }
        
        .policy-item h4 {
            margin: 0 0 15px 0;
            color: var(--text-white);
            font-size: 16px;
            font-weight: 600;
        }
        
        .policy-status-banner {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 12px;
            margin-bottom: 15px;
            display: inline-block;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .policy-status-banner.pass {
            background-color: var(--success-color);
            color: var(--text-white);
        }
        
        .policy-status-banner.fail {
            background-color: var(--danger-color);
            color: var(--text-white);
        }
        
        .policy-details {
            margin-top: 15px;
            padding: 15px;
            background: var(--background-dark);
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }
        
        .policy-details.pass {
            border-left: 3px solid var(--success-color);
        }
        
        .policy-details.fail {
            border-left: 3px solid var(--danger-color);
        }
        
        .policy-description {
            margin: 10px 0;
            padding: 8px 12px;
            background: var(--background-dark);
            border-left: 3px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-secondary);
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        .status-text {
            font-weight: 600;
            font-family: 'Roboto Mono', monospace;
        }
        
        .status-text.pass {
            color: var(--success-color);
        }
        
        .status-text.fail {
            color: var(--danger-color);
        }
        
        .policy-breakdown {
            margin-top: 15px;
            padding: 15px;
            background: var(--background-dark);
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }
        
        .policy-breakdown h4 {
            margin: 0 0 10px 0;
            color: var(--primary-color);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .policy-breakdown ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .policy-breakdown li {
            margin-bottom: 8px;
            color: var(--text-light);
        }
        
        /* CriticalStart Status Classes */
        .severity-high {
            background-color: var(--danger-color);
            color: var(--text-white);
            padding: 5px 10px;
            border-radius: 4px;
            text-align: center;
            font-weight: 600;
        }
        
        .severity-medium {
            background-color: var(--orange-color);
            color: var(--text-white);
            padding: 5px 10px;
            border-radius: 4px;
            text-align: center;
            font-weight: 600;
        }
        
        .severity-low {
            background-color: var(--warning-color);
            color: var(--warning-text);
            padding: 5px 10px;
            border-radius: 4px;
            text-align: center;
            font-weight: 600;
        }
        
        .severity-info {
            background-color: var(--info-color);
            color: var(--text-white);
            padding: 5px 10px;
            border-radius: 4px;
            text-align: center;
            font-weight: 600;
        }
        
        .status-approved {
            background-color: var(--success-color);
            color: var(--text-white);
            padding: 5px 10px;
            border-radius: 4px;
            text-align: center;
            font-weight: 600;
        }
        
        .status-draft {
            background-color: var(--warning-color);
            color: var(--warning-text);
            padding: 5px 10px;
            border-radius: 4px;
            text-align: center;
            font-weight: 600;
        }
        
        .status-expired {
            background-color: var(--danger-color);
            color: var(--text-white);
            padding: 5px 10px;
            border-radius: 4px;
            text-align: center;
            font-weight: 600;
        }
        
        /* Scrollbar Styling for Dark Theme */
        ::-webkit-scrollbar {
            width: 12px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--background-dark);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }
        
        /* Filter Controls */
        .filter-controls {
            background: var(--surface-dark);
            padding: 20px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .filter-controls h3 {
            margin: 0 0 20px 0;
            color: var(--primary-color);
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .filter-switches {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-switch {
            position: relative;
        }
        
        .filter-switch input[type="radio"] {
            display: none;
        }
        
        .filter-label {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: var(--surface-light);
            border: 2px solid var(--border-color);
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            user-select: none;
        }
        
        .filter-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }
        
        .filter-switch input[type="radio"]:checked + .filter-label {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            border-color: var(--primary-color);
            color: var(--text-white);
            box-shadow: 0 4px 8px rgba(0, 156, 222, 0.3);
        }
        
        .filter-switch input[type="radio"]:checked + .filter-label.compliant-filter {
            background: linear-gradient(135deg, var(--success-color) 0%, #1e6b2e 100%);
            border-color: var(--success-color);
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
        }
        
        .filter-switch input[type="radio"]:checked + .filter-label.non-compliant-filter {
            background: linear-gradient(135deg, var(--danger-color) 0%, #a02622 100%);
            border-color: var(--danger-color);
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
        }
        
        .filter-icon {
            font-size: 16px;
        }
        
        .filter-count {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .filter-switch input[type="radio"]:checked + .filter-label .filter-count {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* Hidden items animation */
        .policy-item.hidden {
            display: none !important;
        }
        
        .policy-item.preset-hidden {
            display: none !important;
        }
        
        .section-card.hidden {
            display: none !important;
        }
        
        .preset-hidden {
            display: none !important;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Expected Value Expand/Collapse Styles */
        .expected-value-container {
            display: inline-block;
        }
        
        .expand-btn, .collapse-btn {
            background: var(--primary-color);
            color: var(--text-white);
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s ease;
            margin: 0 2px;
        }
        
        .expand-btn:hover, .collapse-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .expected-value-full {
            word-break: break-all;
            line-height: 1.4;
        }

        /* Preset Policy Toggle Controls */
        .preset-toggle-controls {
            background: var(--surface-dark);
            padding: 20px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
        }
        
        .preset-toggle-controls h3 {
            margin: 0 0 20px 0;
            color: var(--primary-color);
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .toggle-switches {
            display: flex;
            align-items: center;
        }
        
        .toggle-switch {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .toggle-switch input[type="checkbox"] {
            display: none;
        }
        
        .toggle-label {
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            user-select: none;
            padding: 10px 0;
        }
        
        .toggle-slider {
            position: relative;
            width: 60px;
            height: 30px;
            background: var(--border-color);
            border-radius: 15px;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }
        
        .toggle-slider::before {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: var(--text-white);
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .toggle-switch input[type="checkbox"]:checked + .toggle-label .toggle-slider {
            background: var(--primary-color);
        }
        
        .toggle-switch input[type="checkbox"]:checked + .toggle-label .toggle-slider::before {
            transform: translateX(30px);
        }
        
        .toggle-text {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .toggle-text > span:first-child {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 16px;
            color: var(--text-white);
        }
        
        .toggle-info {
            font-size: 13px;
            color: var(--text-light);
            font-style: italic;
            line-height: 1.3;
        }
        
        .toggle-label:hover .toggle-slider {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
        }

        /* Print Styles */
        @media print {
            body {
                background-color: white;
                color: black;
            }
            
            .header {
                background: var(--primary-color) !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .summary-card, .section-card, .policy-item {
                background: white !important;
                border: 1px solid #ddd !important;
                color: black !important;
            }
            
            .filter-controls, .preset-toggle-controls {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>ğŸ›¡ï¸ Posture Assessment Tool Report</h1>
            {% if tenant_info and (tenant_info.displayName or tenant_info.id) %}
            <div class="tenant-info">
                <strong>ğŸ¢ {{ tenant_info.displayName or 'Unknown Organization' }}</strong>
                {% set tenant_id = tenant_info.id or tenant_info.tenantId %}
                {% if tenant_id and tenant_id != 'Unknown' %}
                <span style="margin-left: 20px;">ğŸ†” Tenant ID: {{ tenant_id }}</span>
                {% endif %}
            </div>
            {% endif %}
            <div class="timestamp">ğŸ“… Generated: {{ timestamp }}</div>
        </div>
    </div>

    <div class="container">
        <!-- Preset Policy Toggle Control -->
        <div class="preset-toggle-controls">
            <h3><span class="filter-icon">âš™ï¸</span> Policy Display Options</h3>
            <div style="margin-bottom: 15px; padding: 10px; background: var(--surface-light); border-radius: 6px; border-left: 3px solid var(--info-color);">
                <p style="margin: 0; font-size: 14px; color: var(--text-light);">
                    <strong>ğŸ“Š Statistics Behavior:</strong> When you hide policy types, the statistics recalculate to show only visible policies. 
                    If hidden policies are mostly compliant, the remaining visible set may show higher non-compliant numbers and lower percentages.
                </p>
            </div>
            <div class="toggle-switches">
                <div class="toggle-switch">
                    <input type="checkbox" id="include-preset-policies" checked>
                    <label for="include-preset-policies" class="toggle-label">
                        <span class="toggle-slider"></span>
                        <span class="toggle-text">
                            <span>ğŸ“‹ Include Microsoft Preset Policies</span>
                            <span class="toggle-info">(Standard & Strict Preset Security Policies in Anti-Spam, Anti-Phishing, Anti-Malware, Safe Links, Safe Attachments)</span>
                        </span>
                    </label>
                </div>
                &nbsp;&nbsp;&nbsp;
                <div class="toggle-switch">
                    <input type="checkbox" id="include-default-policies" checked>
                    <label for="include-default-policies" class="toggle-label">
                        <span class="toggle-slider"></span>
                        <span class="toggle-text">
                            <span>âš™ï¸ Include Microsoft Default Policies</span>
                            <span class="toggle-info">(Default, Anti-malware Default Policy, Office365 AntiPhish Default, Built-In Protection Policy)</span>
                        </span>
                    </label>
                </div>
            </div>
        </div>

        <div class="summary-card" id="executive-summary">
            <h2>ğŸ“Š Executive Summary</h2>
            
            <div class="summary-stats">
                <div class="stat-item">
                    <div class="stat-number total">{{ (ca_compliance.total if ca_compliance else 0) + (auth_compliance.total if auth_compliance else 0) + (antispam_inbound_standard_compliance.total if antispam_inbound_standard_compliance else 0) + (antispam_inbound_strict_compliance.total if antispam_inbound_strict_compliance else 0) + (antispam_outbound_compliance.total if antispam_outbound_compliance else 0) + (antiphishing_standard_compliance.total if antiphishing_standard_compliance else 0) + (antiphishing_strict_compliance.total if antiphishing_strict_compliance else 0) + (antimalware_compliance.total if antimalware_compliance else 0) + (safeattachments_compliance.total if safeattachments_compliance else 0) + (safelinks_compliance.total if safelinks_compliance else 0) + (exchangeonline_compliance.total if exchangeonline_compliance else 0) + (dns_compliance.total if dns_compliance else 0) + (antivirus_compliance.total if antivirus_compliance else 0) + (asr_compliance.total if asr_compliance else 0) }}</div>
                    <div class="stat-label">Total Checks</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number compliant">{{ (ca_compliance.passed if ca_compliance else 0) + (auth_compliance.passed if auth_compliance else 0) + (antispam_inbound_standard_compliance.passed if antispam_inbound_standard_compliance else 0) + (antispam_inbound_strict_compliance.passed if antispam_inbound_strict_compliance else 0) + (antispam_outbound_compliance.passed if antispam_outbound_compliance else 0) + (antiphishing_standard_compliance.passed if antiphishing_standard_compliance else 0) + (antiphishing_strict_compliance.passed if antiphishing_strict_compliance else 0) + (antimalware_compliance.passed if antimalware_compliance else 0) + (safeattachments_compliance.passed if safeattachments_compliance else 0) + (safelinks_compliance.passed if safelinks_compliance else 0) + (exchangeonline_compliance.passed if exchangeonline_compliance else 0) + (dns_compliance.passed if dns_compliance else 0) + (antivirus_compliance.passed if antivirus_compliance else 0) + (asr_compliance.passed if asr_compliance else 0) }}</div>
                    <div class="stat-label">Compliant</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number non-compliant">{{ ((ca_compliance.total if ca_compliance else 0) + (auth_compliance.total if auth_compliance else 0) + (antispam_inbound_standard_compliance.total if antispam_inbound_standard_compliance else 0) + (antispam_inbound_strict_compliance.total if antispam_inbound_strict_compliance else 0) + (antispam_outbound_compliance.total if antispam_outbound_compliance else 0) + (antiphishing_standard_compliance.total if antiphishing_standard_compliance else 0) + (antiphishing_strict_compliance.total if antiphishing_strict_compliance else 0) + (antimalware_compliance.total if antimalware_compliance else 0) + (safeattachments_compliance.total if safeattachments_compliance else 0) + (safelinks_compliance.total if safelinks_compliance else 0) + (exchangeonline_compliance.total if exchangeonline_compliance else 0) + (dns_compliance.total if dns_compliance else 0) + (antivirus_compliance.total if antivirus_compliance else 0) + (asr_compliance.total if asr_compliance else 0)) - ((ca_compliance.passed if ca_compliance else 0) + (auth_compliance.passed if auth_compliance else 0) + (antispam_inbound_standard_compliance.passed if antispam_inbound_standard_compliance else 0) + (antispam_inbound_strict_compliance.passed if antispam_inbound_strict_compliance else 0) + (antispam_outbound_compliance.passed if antispam_outbound_compliance else 0) + (antiphishing_standard_compliance.passed if antiphishing_standard_compliance else 0) + (antiphishing_strict_compliance.passed if antiphishing_strict_compliance else 0) + (antimalware_compliance.passed if antimalware_compliance else 0) + (safeattachments_compliance.passed if safeattachments_compliance else 0) + (safelinks_compliance.passed if safelinks_compliance else 0) + (exchangeonline_compliance.passed if exchangeonline_compliance else 0) + (dns_compliance.passed if dns_compliance else 0) + (antivirus_compliance.passed if antivirus_compliance else 0) + (asr_compliance.passed if asr_compliance else 0)) }}</div>
                    <div class="stat-label">Non-Compliant</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number {% if compliance_percentage >= 80 %}compliant{% elif compliance_percentage >= 60 %}total{% else %}non-compliant{% endif %}">{{ compliance_percentage }}%</div>
                    <div class="stat-label">Compliance Rate</div>
                </div>
            </div>
            
            <div class="compliance-bar">
                <div class="compliance-fill" style="width: {{ compliance_percentage }}%"></div>
            </div>
            
            <!-- Section-by-Section Compliance Breakdown -->
            <div style="margin-top: 30px;">
                <h3 style="color: var(--primary-color); margin-bottom: 20px; font-size: 18px;">ğŸ“‹ Compliance Breakdown by Category</h3>
                
                {% if ca_compliance %}
                <div class="compliance-indicator" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; margin-bottom: 12px; background: var(--surface-light); border-radius: 8px; border-left: 4px solid {% if ca_compliance.is_compliant %}var(--success-color){% else %}var(--danger-color){% endif %};">
                    <div style="flex: 1;">
                        <span style="font-weight: 600; color: var(--text-white);">ğŸ” Conditional Access Policies</span>
                        <div style="font-size: 12px; color: var(--text-light); margin-top: 4px;">({{ ca_compliance.passed }}/{{ ca_compliance.total }} Passed)</div>
                    </div>
                    <div style="text-align: right;">
                        <span class="{% if ca_compliance.is_compliant %}status-approved{% else %}status-expired{% endif %}" style="display: inline-block; margin-bottom: 5px;">
                            {% if ca_compliance.is_compliant %}âœ… COMPLIANT{% else %}âŒ NON-COMPLIANT{% endif %}
                        </span>
                        <div style="font-size: 14px; font-weight: bold; color: var(--text-white);">{{ ca_compliance.percentage }}%</div>
                    </div>
                </div>
                {% endif %}
                
                {% if auth_compliance %}
                <div class="compliance-indicator" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; margin-bottom: 12px; background: var(--surface-light); border-radius: 8px; border-left: 4px solid {% if auth_compliance.is_compliant %}var(--success-color){% else %}var(--danger-color){% endif %};">
                    <div style="flex: 1;">
                        <span style="font-weight: 600; color: var(--text-white);">ğŸ›¡ï¸ Authorization Policies</span>
                        <div style="font-size: 12px; color: var(--text-light); margin-top: 4px;">({{ auth_compliance.passed }}/{{ auth_compliance.total }} Passed)</div>
                    </div>
                    <div style="text-align: right;">
                        <span class="{% if auth_compliance.is_compliant %}status-approved{% else %}status-expired{% endif %}" style="display: inline-block; margin-bottom: 5px;">
                            {% if auth_compliance.is_compliant %}âœ… COMPLIANT{% else %}âŒ NON-COMPLIANT{% endif %}
                        </span>
                        <div style="font-size: 14px; font-weight: bold; color: var(--text-white);">{{ auth_compliance.percentage }}%</div>
                    </div>
                </div>
                {% endif %}
                
                {% if antispam_compliance %}
                <div class="compliance-indicator" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; margin-bottom: 12px; background: var(--surface-light); border-radius: 8px; border-left: 4px solid {% if antispam_inbound_standard_compliance.is_compliant %}var(--success-color){% else %}var(--danger-color){% endif %};">
                    <div style="flex: 1;">
                        <span style="font-weight: 600; color: var(--text-white);">ğŸ“§ Anti-Spam Inbound Standard</span>
                        <div style="font-size: 12px; color: var(--text-light); margin-top: 4px;">({{ antispam_inbound_standard_compliance.passed }}/{{ antispam_inbound_standard_compliance.total }} Passed)</div>
                        {% if antispam_inbound_standard_compliance.is_compliant and antispam_inbound_standard_compliance.compliant_policy %}
                        <div style="font-size: 11px; color: var(--success-color); margin-top: 4px; font-style: italic;">âœ“ Policy "{{ antispam_inbound_standard_compliance.compliant_policy }}" meets all requirements</div>
                        {% endif %}
                    </div>
                    <div style="text-align: right;">
                        <span class="{% if antispam_inbound_standard_compliance.is_compliant %}status-approved{% else %}status-expired{% endif %}" style="display: inline-block; margin-bottom: 5px;">
                            {% if antispam_inbound_standard_compliance.is_compliant %}âœ… COMPLIANT{% else %}âŒ NON-COMPLIANT{% endif %}
                        </span>
                        <div style="font-size: 14px; font-weight: bold; color: var(--text-white);">{{ antispam_inbound_standard_compliance.percentage }}%</div>
                    </div>
                </div>
                {% endif %}
                
                {% if antiphishing_compliance %}
                <div class="compliance-indicator" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; margin-bottom: 12px; background: var(--surface-light); border-radius: 8px; border-left: 4px solid {% if antiphishing_standard_compliance.is_compliant %}var(--success-color){% else %}var(--danger-color){% endif %};">
                    <div style="flex: 1;">
                        <span style="font-weight: 600; color: var(--text-white);">ğŸ£ Anti-Phishing Policies</span>
                        <div style="font-size: 12px; color: var(--text-light); margin-top: 4px;">({{ antiphishing_standard_compliance.passed }}/{{ antiphishing_standard_compliance.total }} Passed)</div>
                        {% if antiphishing_standard_compliance.is_compliant and antiphishing_standard_compliance.compliant_policy %}
                        <div style="font-size: 11px; color: var(--success-color); margin-top: 4px; font-style: italic;">âœ“ Policy "{{ antiphishing_standard_compliance.compliant_policy }}" meets all requirements</div>
                        {% endif %}
                    </div>
                    <div style="text-align: right;">
                        <span class="{% if antiphishing_standard_compliance.is_compliant %}status-approved{% else %}status-expired{% endif %}" style="display: inline-block; margin-bottom: 5px;">
                            {% if antiphishing_standard_compliance.is_compliant %}âœ… COMPLIANT{% else %}âŒ NON-COMPLIANT{% endif %}
                        </span>
                        <div style="font-size: 14px; font-weight: bold; color: var(--text-white);">{{ antiphishing_standard_compliance.percentage }}%</div>
                    </div>
                </div>
                {% endif %}
                
                {% if antimalware_compliance %}
                <div class="compliance-indicator" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; margin-bottom: 12px; background: var(--surface-light); border-radius: 8px; border-left: 4px solid {% if antimalware_compliance.is_compliant %}var(--success-color){% else %}var(--danger-color){% endif %};">
                    <div style="flex: 1;">
                        <span style="font-weight: 600; color: var(--text-white);">ğŸ¦  Anti-Malware Policies</span>
                        <div style="font-size: 12px; color: var(--text-light); margin-top: 4px;">({{ antimalware_compliance.passed }}/{{ antimalware_compliance.total }} Passed)</div>
                        {% if antimalware_compliance.is_compliant and antimalware_compliance.compliant_policy %}
                        <div style="font-size: 11px; color: var(--success-color); margin-top: 4px; font-style: italic;">âœ“ Policy "{{ antimalware_compliance.compliant_policy }}" meets all requirements</div>
                        {% endif %}
                    </div>
                    <div style="text-align: right;">
                        <span class="{% if antimalware_compliance.is_compliant %}status-approved{% else %}status-expired{% endif %}" style="display: inline-block; margin-bottom: 5px;">
                            {% if antimalware_compliance.is_compliant %}âœ… COMPLIANT{% else %}âŒ NON-COMPLIANT{% endif %}
                        </span>
                        <div style="font-size: 14px; font-weight: bold; color: var(--text-white);">{{ antimalware_compliance.percentage }}%</div>
                    </div>
                </div>
                {% endif %}
                
                {% if safeattachments_compliance %}
                <div class="compliance-indicator" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; margin-bottom: 12px; background: var(--surface-light); border-radius: 8px; border-left: 4px solid {% if safeattachments_compliance.is_compliant %}var(--success-color){% else %}var(--danger-color){% endif %};">
                    <div style="flex: 1;">
                        <span style="font-weight: 600; color: var(--text-white);">ğŸ“ Safe Attachments Policies</span>
                        <div style="font-size: 12px; color: var(--text-light); margin-top: 4px;">({{ safeattachments_compliance.passed }}/{{ safeattachments_compliance.total }} Passed)</div>
                        {% if safeattachments_compliance.is_compliant and safeattachments_compliance.compliant_policy %}
                        <div style="font-size: 11px; color: var(--success-color); margin-top: 4px; font-style: italic;">âœ“ Policy "{{ safeattachments_compliance.compliant_policy }}" meets all requirements</div>
                        {% endif %}
                    </div>
                    <div style="text-align: right;">
                        <span class="{% if safeattachments_compliance.is_compliant %}status-approved{% else %}status-expired{% endif %}" style="display: inline-block; margin-bottom: 5px;">
                            {% if safeattachments_compliance.is_compliant %}âœ… COMPLIANT{% else %}âŒ NON-COMPLIANT{% endif %}
                        </span>
                        <div style="font-size: 14px; font-weight: bold; color: var(--text-white);">{{ safeattachments_compliance.percentage }}%</div>
                    </div>
                </div>
                {% endif %}
                
                {% if safelinks_compliance %}
                <div class="compliance-indicator" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; margin-bottom: 12px; background: var(--surface-light); border-radius: 8px; border-left: 4px solid {% if safelinks_compliance.is_compliant %}var(--success-color){% else %}var(--danger-color){% endif %};">
                    <div style="flex: 1;">
                        <span style="font-weight: 600; color: var(--text-white);">ğŸ”— Safe Links Policies</span>
                        <div style="font-size: 12px; color: var(--text-light); margin-top: 4px;">({{ safelinks_compliance.passed }}/{{ safelinks_compliance.total }} Passed)</div>
                        {% if safelinks_compliance.is_compliant and safelinks_compliance.compliant_policy %}
                        <div style="font-size: 11px; color: var(--success-color); margin-top: 4px; font-style: italic;">âœ“ Policy "{{ safelinks_compliance.compliant_policy }}" meets all requirements</div>
                        {% endif %}
                    </div>
                    <div style="text-align: right;">
                        <span class="{% if safelinks_compliance.is_compliant %}status-approved{% else %}status-expired{% endif %}" style="display: inline-block; margin-bottom: 5px;">
                            {% if safelinks_compliance.is_compliant %}âœ… COMPLIANT{% else %}âŒ NON-COMPLIANT{% endif %}
                        </span>
                        <div style="font-size: 14px; font-weight: bold; color: var(--text-white);">{{ safelinks_compliance.percentage }}%</div>
                    </div>
                </div>
                {% endif %}
                
                {% if exchangeonline_compliance %}
                <div class="compliance-indicator" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; margin-bottom: 12px; background: var(--surface-light); border-radius: 8px; border-left: 4px solid {% if exchangeonline_compliance.is_compliant %}var(--success-color){% else %}var(--danger-color){% endif %};">
                    <div style="flex: 1;">
                        <span style="font-weight: 600; color: var(--text-white);">ğŸ“¨ Exchange Online Configurations</span>
                        <div style="font-size: 12px; color: var(--text-light); margin-top: 4px;">({{ exchangeonline_compliance.passed }}/{{ exchangeonline_compliance.total }} Passed)</div>
                        {% if exchangeonline_compliance.is_compliant and exchangeonline_compliance.compliant_policy %}
                        <div style="font-size: 11px; color: var(--success-color); margin-top: 4px; font-style: italic;">âœ“ All general settings meet requirements</div>
                        {% endif %}
                    </div>
                    <div style="text-align: right;">
                        <span class="{% if exchangeonline_compliance.is_compliant %}status-approved{% else %}status-expired{% endif %}" style="display: inline-block; margin-bottom: 5px;">
                            {% if exchangeonline_compliance.is_compliant %}âœ… COMPLIANT{% else %}âŒ NON-COMPLIANT{% endif %}
                        </span>
                        <div style="font-size: 14px; font-weight: bold; color: var(--text-white);">{{ exchangeonline_compliance.percentage }}%</div>
                    </div>
                </div>
                {% endif %}
                
                {% if dns_compliance %}
                <div class="compliance-indicator" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; margin-bottom: 12px; background: var(--surface-light); border-radius: 8px; border-left: 4px solid {% if dns_compliance.is_compliant %}var(--success-color){% else %}var(--danger-color){% endif %};">
                    <div style="flex: 1;">
                        <span style="font-weight: 600; color: var(--text-white);">ğŸŒ DNS Security Configurations</span>
                        <div style="font-size: 12px; color: var(--text-light); margin-top: 4px;">({{ dns_compliance.passed }}/{{ dns_compliance.total }} Passed)</div>
                    </div>
                    <div style="text-align: right;">
                        <span class="{% if dns_compliance.is_compliant %}status-approved{% else %}status-expired{% endif %}" style="display: inline-block; margin-bottom: 5px;">
                            {% if dns_compliance.is_compliant %}âœ… COMPLIANT{% else %}âŒ NON-COMPLIANT{% endif %}
                        </span>
                        <div style="font-size: 14px; font-weight: bold; color: var(--text-white);">{{ dns_compliance.percentage }}%</div>
                    </div>
                </div>
                {% endif %}
                
                {% if antivirus_compliance %}
                <div class="compliance-indicator" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; margin-bottom: 12px; background: var(--surface-light); border-radius: 8px; border-left: 4px solid {% if antivirus_compliance.is_compliant %}var(--success-color){% else %}var(--danger-color){% endif %};">
                    <div style="flex: 1;">
                        <span style="font-weight: 600; color: var(--text-white);">ğŸ›¡ï¸ Defender Antivirus</span>
                        <div style="font-size: 12px; color: var(--text-light); margin-top: 4px;">({{ antivirus_compliance.passed }}/{{ antivirus_compliance.total }} Passed)</div>
                        {% if antivirus_compliance.is_compliant and antivirus_compliance.compliant_policy %}
                        <div style="font-size: 11px; color: var(--success-color); margin-top: 4px; font-style: italic;">âœ“ Policy "{{ antivirus_compliance.compliant_policy }}" meets all requirements</div>
                        {% endif %}
                    </div>
                    <div style="text-align: right;">
                        <span class="{% if antivirus_compliance.is_compliant %}status-approved{% else %}status-expired{% endif %}" style="display: inline-block; margin-bottom: 5px;">
                            {% if antivirus_compliance.is_compliant %}âœ… COMPLIANT{% else %}âŒ NON-COMPLIANT{% endif %}
                        </span>
                        <div style="font-size: 14px; font-weight: bold; color: var(--text-white);">{{ antivirus_compliance.percentage }}%</div>
                    </div>
                </div>
                {% endif %}
                
                {% if asr_compliance %}
                <div class="compliance-indicator" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; margin-bottom: 12px; background: var(--surface-light); border-radius: 8px; border-left: 4px solid {% if asr_compliance.is_compliant %}var(--success-color){% else %}var(--danger-color){% endif %};">
                    <div style="flex: 1;">
                        <span style="font-weight: 600; color: var(--text-white);">ğŸ”’ Attack Surface Reduction</span>
                        <div style="font-size: 12px; color: var(--text-light); margin-top: 4px;">({{ asr_compliance.passed }}/{{ asr_compliance.total }} Passed)</div>
                        {% if asr_compliance.is_compliant and asr_compliance.compliant_policy %}
                        <div style="font-size: 11px; color: var(--success-color); margin-top: 4px; font-style: italic;">âœ“ Policy "{{ asr_compliance.compliant_policy }}" meets all requirements</div>
                        {% endif %}
                    </div>
                    <div style="text-align: right;">
                        <span class="{% if asr_compliance.is_compliant %}status-approved{% else %}status-expired{% endif %}" style="display: inline-block; margin-bottom: 5px;">
                            {% if asr_compliance.is_compliant %}âœ… COMPLIANT{% else %}âŒ NON-COMPLIANT{% endif %}
                        </span>
                        <div style="font-size: 14px; font-weight: bold; color: var(--text-white);">{{ asr_compliance.percentage }}%</div>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <p style="text-align: center; margin-top: 25px; color: var(--text-light); font-size: 16px; font-weight: 500;">
                {% if compliance_percentage >= 90 %}
                    ğŸ† Excellent security posture! Your organization demonstrates strong adherence to security best practices.
                {% elif compliance_percentage >= 80 %}
                    âœ… Good security posture with room for minor improvements.
                {% elif compliance_percentage >= 60 %}
                    âš ï¸ Moderate security posture. Several areas need attention to improve security stance.
                {% else %}
                    ğŸš¨ Security posture needs significant improvement. Multiple critical issues require immediate attention.
                {% endif %}
            </p>
        </div>

        <!-- Filter Controls -->
        <div class="filter-controls">
            <h3><span class="filter-icon">ğŸ”</span> Filter Results</h3>
            <div class="filter-switches">
                <div class="filter-switch">
                    <input type="radio" id="filter-all" name="compliance-filter" value="all" checked>
                    <label for="filter-all" class="filter-label">
                        <span class="filter-icon">ğŸ“‹</span>
                        <span>Show All</span>
                        <span class="filter-count" id="count-all">0</span>
                    </label>
                </div>
                <div class="filter-switch">
                    <input type="radio" id="filter-compliant" name="compliance-filter" value="compliant">
                    <label for="filter-compliant" class="filter-label compliant-filter">
                        <span class="filter-icon">âœ…</span>
                        <span>Compliant Only</span>
                        <span class="filter-count" id="count-compliant">0</span>
                    </label>
                </div>
                <div class="filter-switch">
                    <input type="radio" id="filter-non-compliant" name="compliance-filter" value="non-compliant">
                    <label for="filter-non-compliant" class="filter-label non-compliant-filter">
                        <span class="filter-icon">âŒ</span>
                        <span>Non-Compliant Only</span>
                        <span class="filter-count" id="count-non-compliant">0</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Conditional Access Policies -->
        {% if ca_results %}
        <div class="section-card" data-section="conditional-access">
            <div class="section-header">
                <h3>ğŸ” Entra ID Conditional Access Policies</h3>
            </div>
            <div class="section-content">
                {% for result in ca_results %}
                {% set status = result.status %}
                {% set is_compliant = status.startswith('COMPLIANT') or (result.found and not status.startswith('NON-COMPLIANT') and 'ERROR' not in status) %}
                <div class="policy-item {% if is_compliant %}pass{% else %}fail{% endif %}" data-compliance="{% if is_compliant %}compliant{% else %}non-compliant{% endif %}">
                    <div class="policy-status-banner {% if is_compliant %}pass{% else %}fail{% endif %}">
                        {% if is_compliant %}âœ… COMPLIANT{% else %}âŒ NON-COMPLIANT{% endif %}
                    </div>
                    <h4>{{ result.check_id }} - {{ result.requirement_name }}</h4>
                    {% if result.description %}
                    <p class="policy-description"><em>{{ result.description }}</em></p>
                    {% endif %}
                    <div class="policy-details {% if is_compliant %}pass{% else %}fail{% endif %}">
                        <p><strong>Status:</strong> <span class="status-text {% if is_compliant %}pass{% else %}fail{% endif %}">{{ result.status }}</span></p>
                        <p><strong>Policy Found:</strong> {{ result.found }}</p>
                        {% if result.expected_value is defined %}
                        <p><strong>Expected Configuration:</strong> {{ result.expected_value }}</p>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Authorization Policy -->
        {% if auth_results %}
        <div class="section-card" data-section="authorization">
            <div class="section-header">
                <h3>ğŸ›¡ï¸ Entra ID Authorization Policies</h3>
            </div>
            <div class="section-content">
                {% for result in auth_results %}
                {% set status = result.status %}
                {% if result.is_compliant is defined %}
                    {% set is_compliant = result.is_compliant %}
                {% else %}
                    {% set is_compliant = status.startswith('PRESENT') and not status.startswith('MISSING') %}
                {% endif %}
                <div class="policy-item {% if is_compliant %}pass{% else %}fail{% endif %}" data-compliance="{% if is_compliant %}compliant{% else %}non-compliant{% endif %}">
                    <div class="policy-status-banner {% if is_compliant %}pass{% else %}fail{% endif %}">
                        {% if is_compliant %}âœ… COMPLIANT{% else %}âŒ NON-COMPLIANT{% endif %}
                    </div>
                    <h4>{{ result.check_id }} - {{ result.requirement_name }}</h4>
                    {% if result.description %}
                    <p class="policy-description"><em>{{ result.description }}</em></p>
                    {% endif %}
                    <div class="policy-details {% if is_compliant %}pass{% else %}fail{% endif %}">
                        <p><strong>Status:</strong> <span class="status-text {% if is_compliant %}pass{% else %}fail{% endif %}">{{ result.status }}</span></p>
                        <p><strong>Policy Found:</strong> {{ result.found }}</p>
                        {% if result.expected_value is defined %}
                        <p><strong>Expected Configuration:</strong> {{ result.expected_value }}</p>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Anti-Spam Policies -->
        {% if antispam_results %}
        <div class="section-card">
            <div class="section-header">
                <h3>ğŸ“§ Defender for Office 365 - Anti-Spam Policies</h3>
            </div>
            <div class="section-content">
                {% for result in antispam_results %}
                {% set status = result.status %}
                <div class="policy-item {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}" data-compliance="{% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}compliant{% else %}non-compliant{% endif %}">
                    <div class="policy-status-banner {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">
                        {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}âœ… COMPLIANT{% else %}âŒ NON-COMPLIANT{% endif %}
                    </div>
                    <h4>{{ result.check_id }} - {{ result.requirement_name }}</h4>
                    <div class="policy-details {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">
                        <p><strong>Status:</strong> <span class="status-text {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">{{ result.status }}</span></p>
                        <p><strong>Policy Found:</strong> {{ result.found }}</p>
                        {% if result.expected_value is defined %}
                        <p><strong>Expected Value:</strong> 
                            {% if result.expected_value is iterable and result.expected_value is not string %}
                                {% if result.expected_value|length > 5 %}
                                    <div class="expected-value-container">
                                        <span class="expected-value-truncated">[{{ result.expected_value[:5]|join(', ') }}, ... ({{ result.expected_value|length - 5 }} more)] 
                                            <button class="expand-btn" onclick="toggleExpectedValue(this)">Show More</button>
                                        </span>
                                        <span class="expected-value-full" style="display: none;">
                                            [{{ result.expected_value|join(', ') }}] 
                                            <button class="collapse-btn" onclick="toggleExpectedValue(this)">Show Less</button>
                                        </span>
                                    </div>
                                {% else %}
                                    [{{ result.expected_value|join(', ') }}]
                                {% endif %}
                            {% else %}
                                {{ result.expected_value }}
                            {% endif %}
                        </p>
                        {% endif %}
                        {% if result.policy_results %}
                        <div class="policy-breakdown">
                            <h4>Policy Details:</h4>
                            <ul>
                            {% for policy_result in result.policy_results %}
                                <li>{{ policy_result.policy_name }}: 
                                    {% if policy_result.is_compliant %}
                                        <span style="color: var(--success-color);">âœ“ COMPLIANT</span>
                                    {% else %}
                                        <span style="color: var(--danger-color);">âœ— NON-COMPLIANT</span>
                                    {% endif %}
                                    {% if policy_result.current_value is defined %}
                                        (Current: {{ policy_result.current_value }})
                                    {% endif %}
                                </li>
                            {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Anti-Phishing Policies -->
        {% if antiphishing_results %}
        <div class="section-card">
            <div class="section-header">
                <h3>ğŸ£ Defender for Office 365 - Anti-Phishing Policies</h3>
            </div>
            <div class="section-content">
                {% for result in antiphishing_results %}
                {% set status = result.status %}
                <div class="policy-item {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}" data-compliance="{% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}compliant{% else %}non-compliant{% endif %}">
                    <div class="policy-status-banner {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">
                        {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}âœ… COMPLIANT{% else %}âŒ NON-COMPLIANT{% endif %}
                    </div>
                    <h4>{{ result.check_id }} - {{ result.requirement_name }}</h4>
                    <div class="policy-details {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">
                        <p><strong>Status:</strong> <span class="status-text {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">{{ result.status }}</span></p>
                        <p><strong>Policy Found:</strong> {{ result.found }}</p>
                        {% if result.expected_value is defined %}
                        <p><strong>Expected Value:</strong> 
                            {% if result.expected_value is iterable and result.expected_value is not string %}
                                {% if result.expected_value|length > 5 %}
                                    <div class="expected-value-container">
                                        <span class="expected-value-truncated">[{{ result.expected_value[:5]|join(', ') }}, ... ({{ result.expected_value|length - 5 }} more)] 
                                            <button class="expand-btn" onclick="toggleExpectedValue(this)">Show More</button>
                                        </span>
                                        <span class="expected-value-full" style="display: none;">
                                            [{{ result.expected_value|join(', ') }}] 
                                            <button class="collapse-btn" onclick="toggleExpectedValue(this)">Show Less</button>
                                        </span>
                                    </div>
                                {% else %}
                                    [{{ result.expected_value|join(', ') }}]
                                {% endif %}
                            {% else %}
                                {{ result.expected_value }}
                            {% endif %}
                        </p>
                        {% endif %}
                        {% if result.policy_results %}
                        <div class="policy-breakdown">
                            <h4>Policy Details:</h4>
                            <ul>
                            {% for policy_result in result.policy_results %}
                                <li>{{ policy_result.policy_name }}: 
                                    {% if policy_result.is_compliant %}
                                        <span style="color: var(--success-color);">âœ“ COMPLIANT</span>
                                    {% else %}
                                        <span style="color: var(--danger-color);">âœ— NON-COMPLIANT</span>
                                    {% endif %}
                                    {% if policy_result.current_value is defined %}
                                        (Current: {{ policy_result.current_value }})
                                    {% endif %}
                                </li>
                            {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Anti-Malware Policies -->
        {% if antimalware_results %}
        <div class="section-card">
            <div class="section-header">
                <h3>ğŸ¦  Defender for Office 365 - Anti-Malware Policies</h3>
            </div>
            <div class="section-content">
                {% for result in antimalware_results %}
                {% set status = result.status %}
                <div class="policy-item {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}" data-compliance="{% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}compliant{% else %}non-compliant{% endif %}">
                    <div class="policy-status-banner {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">
                        {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}âœ… COMPLIANT{% else %}âŒ NON-COMPLIANT{% endif %}
                    </div>
                    <h4>{{ result.check_id }} - {{ result.requirement_name }}</h4>
                    <div class="policy-details {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">
                        <p><strong>Status:</strong> <span class="status-text {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">{{ result.status }}</span></p>
                        <p><strong>Policy Found:</strong> {{ result.found }}</p>
                        {% if result.expected_value is defined %}
                        <p><strong>Expected Value:</strong> 
                            {% if result.expected_value is iterable and result.expected_value is not string %}
                                {% if result.expected_value|length > 5 %}
                                    <div class="expected-value-container">
                                        <span class="expected-value-truncated">[{{ result.expected_value[:5]|join(', ') }}, ... ({{ result.expected_value|length - 5 }} more)] 
                                            <button class="expand-btn" onclick="toggleExpectedValue(this)">Show More</button>
                                        </span>
                                        <span class="expected-value-full" style="display: none;">
                                            [{{ result.expected_value|join(', ') }}] 
                                            <button class="collapse-btn" onclick="toggleExpectedValue(this)">Show Less</button>
                                        </span>
                                    </div>
                                {% else %}
                                    [{{ result.expected_value|join(', ') }}]
                                {% endif %}
                            {% else %}
                                {{ result.expected_value }}
                            {% endif %}
                        </p>
                        {% endif %}
                        {% if result.policy_results %}
                        <div class="policy-breakdown">
                            <h4>Policy Details:</h4>
                            <ul>
                            {% for policy_result in result.policy_results %}
                                <li>{{ policy_result.policy_name }}: 
                                    {% if policy_result.is_compliant %}
                                        <span style="color: var(--success-color);">âœ“ COMPLIANT</span>
                                    {% else %}
                                        <span style="color: var(--danger-color);">âœ— NON-COMPLIANT</span>
                                    {% endif %}
                                    {% if policy_result.current_value is defined %}
                                        (Current: {{ policy_result.current_value }})
                                    {% endif %}
                                </li>
                            {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Safe Attachments Policies -->
        {% if safeattachments_results %}
        <div class="section-card">
            <div class="section-header">
                <h3>ğŸ“ Defender for Office 365 - Safe Attachments Policies</h3>
            </div>
            <div class="section-content">
                {% for result in safeattachments_results %}
                {% set status = result.status %}
                <div class="policy-item {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}" data-compliance="{% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}compliant{% else %}non-compliant{% endif %}">
                    <div class="policy-status-banner {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">
                        {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}âœ… COMPLIANT{% else %}âŒ NON-COMPLIANT{% endif %}
                    </div>
                    <h4>{{ result.check_id }} - {{ result.requirement_name }}</h4>
                    <div class="policy-details {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">
                        <p><strong>Status:</strong> <span class="status-text {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">{{ result.status }}</span></p>
                        <p><strong>Policy Found:</strong> {{ result.found }}</p>
                        {% if result.expected_value is defined %}
                        <p><strong>Expected Value:</strong> 
                            {% if result.expected_value is iterable and result.expected_value is not string %}
                                {% if result.expected_value|length > 5 %}
                                    <div class="expected-value-container">
                                        <span class="expected-value-truncated">[{{ result.expected_value[:5]|join(', ') }}, ... ({{ result.expected_value|length - 5 }} more)] 
                                            <button class="expand-btn" onclick="toggleExpectedValue(this)">Show More</button>
                                        </span>
                                        <span class="expected-value-full" style="display: none;">
                                            [{{ result.expected_value|join(', ') }}] 
                                            <button class="collapse-btn" onclick="toggleExpectedValue(this)">Show Less</button>
                                        </span>
                                    </div>
                                {% else %}
                                    [{{ result.expected_value|join(', ') }}]
                                {% endif %}
                            {% else %}
                                {{ result.expected_value }}
                            {% endif %}
                        </p>
                        {% endif %}
                        {% if result.policy_results %}
                        <div class="policy-breakdown">
                            <h4>Policy Details:</h4>
                            <ul>
                            {% for policy_result in result.policy_results %}
                                <li>{{ policy_result.policy_name }}: 
                                    {% if policy_result.is_compliant %}
                                        <span style="color: var(--success-color);">âœ“ COMPLIANT</span>
                                    {% else %}
                                        <span style="color: var(--danger-color);">âœ— NON-COMPLIANT</span>
                                    {% endif %}
                                    {% if policy_result.current_value is defined %}
                                        (Current: {{ policy_result.current_value }})
                                    {% endif %}
                                </li>
                            {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Safe Links Policies -->
        {% if safelinks_results %}
        <div class="section-card">
            <div class="section-header">
                <h3>ğŸ”— Defender for Office 365 - Safe Links Policies</h3>
            </div>
            <div class="section-content">
                {% for result in safelinks_results %}
                {% set status = result.status %}
                <div class="policy-item {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}" data-compliance="{% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}compliant{% else %}non-compliant{% endif %}">
                    <div class="policy-status-banner {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">
                        {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}âœ… COMPLIANT{% else %}âŒ NON-COMPLIANT{% endif %}
                    </div>
                    <h4>{{ result.check_id }} - {{ result.requirement_name }}</h4>
                    <div class="policy-details {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">
                        <p><strong>Status:</strong> <span class="status-text {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">{{ result.status }}</span></p>
                        <p><strong>Policy Found:</strong> {{ result.found }}</p>
                        {% if result.expected_value is defined %}
                        <p><strong>Expected Value:</strong> 
                            {% if result.expected_value is iterable and result.expected_value is not string %}
                                {% if result.expected_value|length > 5 %}
                                    <div class="expected-value-container">
                                        <span class="expected-value-truncated">[{{ result.expected_value[:5]|join(', ') }}, ... ({{ result.expected_value|length - 5 }} more)] 
                                            <button class="expand-btn" onclick="toggleExpectedValue(this)">Show More</button>
                                        </span>
                                        <span class="expected-value-full" style="display: none;">
                                            [{{ result.expected_value|join(', ') }}] 
                                            <button class="collapse-btn" onclick="toggleExpectedValue(this)">Show Less</button>
                                        </span>
                                    </div>
                                {% else %}
                                    [{{ result.expected_value|join(', ') }}]
                                {% endif %}
                            {% else %}
                                {{ result.expected_value }}
                            {% endif %}
                        </p>
                        {% endif %}
                        {% if result.policy_results %}
                        <div class="policy-breakdown">
                            <h4>Policy Details:</h4>
                            <ul>
                            {% for policy_result in result.policy_results %}
                                <li>{{ policy_result.policy_name }}: 
                                    {% if policy_result.is_compliant %}
                                        <span style="color: var(--success-color);">âœ“ COMPLIANT</span>
                                    {% else %}
                                        <span style="color: var(--danger-color);">âœ— NON-COMPLIANT</span>
                                    {% endif %}
                                    {% if policy_result.current_value is defined %}
                                        (Current: {{ policy_result.current_value }})
                                    {% endif %}
                                </li>
                            {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Exchange Online Configurations -->
        {% if exchangeonline_results %}
        <div class="section-card">
            <div class="section-header">
                <h3>ğŸ“¨ Exchange Online Configurations</h3>
            </div>
            <div class="section-content">
                {% for result in exchangeonline_results %}
                {% set status = result.status %}
                <div class="policy-item {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}" data-compliance="{% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}compliant{% else %}non-compliant{% endif %}">
                    <div class="policy-status-banner {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">
                        {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}âœ… COMPLIANT{% else %}âŒ NON-COMPLIANT{% endif %}
                    </div>
                    <h4>{{ result.check_id }} - {{ result.requirement_name }}</h4>
                    <div class="policy-details {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">
                        <p><strong>Status:</strong> <span class="status-text {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">{{ result.status }}</span></p>
                        <p><strong>Policy Found:</strong> {{ result.found }}</p>
                        {% if result.expected_value is defined %}
                        <p><strong>Expected Value:</strong> 
                            {% if result.expected_value is iterable and result.expected_value is not string %}
                                {% if result.expected_value|length > 5 %}
                                    <div class="expected-value-container">
                                        <span class="expected-value-truncated">[{{ result.expected_value[:5]|join(', ') }}, ... ({{ result.expected_value|length - 5 }} more)] 
                                            <button class="expand-btn" onclick="toggleExpectedValue(this)">Show More</button>
                                        </span>
                                        <span class="expected-value-full" style="display: none;">
                                            [{{ result.expected_value|join(', ') }}] 
                                            <button class="collapse-btn" onclick="toggleExpectedValue(this)">Show Less</button>
                                        </span>
                                    </div>
                                {% else %}
                                    [{{ result.expected_value|join(', ') }}]
                                {% endif %}
                            {% else %}
                                {{ result.expected_value }}
                            {% endif %}
                        </p>
                        {% endif %}
                        {% if result.policy_results %}
                        <div class="policy-breakdown">
                            <h4>Policy Details:</h4>
                            <ul>
                            {% for policy_result in result.policy_results %}
                                <li>{{ policy_result.policy_name }}: 
                                    {% if policy_result.is_compliant %}
                                        <span style="color: var(--success-color);">âœ“ COMPLIANT</span>
                                    {% else %}
                                        <span style="color: var(--danger-color);">âœ— NON-COMPLIANT</span>
                                    {% endif %}
                                    {% if policy_result.current_value is defined %}
                                        (Current: {{ policy_result.current_value }})
                                    {% endif %}
                                </li>
                            {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- DNS Configurations -->
        {% if dns_results %}
        <div class="section-card">
            <div class="section-header">
                <h3>ğŸŒ DNS Security Configurations</h3>
            </div>
            <div class="section-content">
                {% for result in dns_results %}
                {% set status = result.status %}
                {% set is_compliant = result.is_compliant if result.is_compliant is defined else (status.startswith('COMPLIANT') or (result.found and not status.startswith('NON-COMPLIANT') and 'ERROR' not in status)) %}
                <div class="policy-item {% if is_compliant %}pass{% else %}fail{% endif %}" data-compliance="{% if is_compliant %}compliant{% else %}non-compliant{% endif %}">
                    <div class="policy-status-banner {% if is_compliant %}pass{% else %}fail{% endif %}">
                        {% if is_compliant %}âœ… COMPLIANT{% else %}âŒ NON-COMPLIANT{% endif %}
                    </div>
                    <h4>{{ result.check_id }} - {{ result.requirement_name }}</h4>
                    <div class="policy-details {% if is_compliant %}pass{% else %}fail{% endif %}">
                        <p><strong>Status:</strong> <span class="status-text {% if is_compliant %}pass{% else %}fail{% endif %}">{{ result.status }}</span></p>
                        <p><strong>Configuration Found:</strong> {{ result.found }}</p>
                        {% if result.expected_value is defined %}
                        <p><strong>Expected Configuration:</strong> {{ result.expected_value }}</p>
                        {% endif %}
                        {% if result.current_value is defined and result.current_value %}
                        <p><strong>Current Configuration:</strong> 
                            {% if result.current_value is mapping %}
                                <ul style="margin: 5px 0; padding-left: 20px;">
                                {% for key, value in result.current_value.items() %}
                                    <li><strong>{{ key }}:</strong> {{ value }}</li>
                                {% endfor %}
                                </ul>
                            {% elif result.current_value is iterable and result.current_value is not string %}
                                <ul style="margin: 5px 0; padding-left: 20px;">
                                {% for item in result.current_value %}
                                    <li>{{ item }}</li>
                                {% endfor %}
                                </ul>
                            {% else %}
                                {{ result.current_value }}
                            {% endif %}
                        </p>
                        {% endif %}
                        {% if result.details is defined and result.details %}
                        <div class="policy-breakdown">
                            <h4>DNS Record Details:</h4>
                            {% if result.details.records is defined and result.details.records %}
                            <ul>
                            {% for record in result.details.records %}
                                <li style="font-family: 'Roboto Mono', monospace; font-size: 12px; word-break: break-all;">{{ record }}</li>
                            {% endfor %}
                            </ul>
                            {% endif %}
                            {% if result.details.status is defined %}
                            <p><strong>DNS Status:</strong> {{ result.details.status }}</p>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Defender for Endpoint - Antivirus -->
        {% if antivirus_results %}
        <div class="section-card">
            <div class="section-header">
                <h3>ğŸ›¡ï¸ Defender for Endpoint - Antivirus Policies</h3>
            </div>
            <div class="section-content">
                {% for result in antivirus_results %}
                {% set status = result.status %}
                <div class="policy-item {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}" data-compliance="{% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}compliant{% else %}non-compliant{% endif %}">
                    <div class="policy-status-banner {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">
                        {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}âœ… COMPLIANT{% else %}âŒ NON-COMPLIANT{% endif %}
                    </div>
                    <h4>{{ result.check_id }} - {{ result.requirement_name }}</h4>
                    <div class="policy-details {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">
                        <p><strong>Configuration Status:</strong> <span class="status-text {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">{{ result.status }}</span></p>
                        <p><strong>Policy Found:</strong> {{ result.found }}</p>
                        {% if result.expected_value is defined %}
                        <p><strong>Expected Value:</strong> 
                            {% if result.expected_value is iterable and result.expected_value is not string %}
                                {% if result.expected_value|length > 5 %}
                                    <div class="expected-value-container">
                                        <span class="expected-value-truncated">[{{ result.expected_value[:5]|join(', ') }}, ... ({{ result.expected_value|length - 5 }} more)] 
                                            <button class="expand-btn" onclick="toggleExpectedValue(this)">Show More</button>
                                        </span>
                                        <span class="expected-value-full" style="display: none;">
                                            [{{ result.expected_value|join(', ') }}] 
                                            <button class="collapse-btn" onclick="toggleExpectedValue(this)">Show Less</button>
                                        </span>
                                    </div>
                                {% else %}
                                    [{{ result.expected_value|join(', ') }}]
                                {% endif %}
                            {% else %}
                                {{ result.expected_value }}
                            {% endif %}
                        </p>
                        {% endif %}
                        {% if result.policy_results %}
                        <div class="policy-breakdown">
                            <h4>Policy Details:</h4>
                            <ul>
                            {% for policy_result in result.policy_results %}
                                <li>{{ policy_result.policy_name }}: 
                                    {% if policy_result.is_compliant %}
                                        <span style="color: var(--success-color);">âœ“ COMPLIANT</span>
                                    {% else %}
                                        <span style="color: var(--danger-color);">âœ— NON-COMPLIANT</span>
                                    {% endif %}
                                    {% if policy_result.current_value is defined %}
                                        (Current: {{ policy_result.current_value }})
                                    {% endif %}
                                </li>
                            {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Defender for Endpoint - Attack Surface Reduction -->
        {% if asr_results %}
        <div class="section-card">
            <div class="section-header">
                <h3>ğŸ”’ Defender for Endpoint - Attack Surface Reduction</h3>
            </div>
            <div class="section-content">
                {% for result in asr_results %}
                {% set status = result.status %}
                <div class="policy-item {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}" data-compliance="{% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}compliant{% else %}non-compliant{% endif %}">
                    <div class="policy-status-banner {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">
                        {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}âœ… COMPLIANT{% else %}âŒ NON-COMPLIANT{% endif %}
                    </div>
                    <h4>{{ result.check_id }} - {{ result.requirement_name }}</h4>
                    <div class="policy-details {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">
                        <p><strong>Configuration Status:</strong> <span class="status-text {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">{{ result.status }}</span></p>
                        <p><strong>Policy Found:</strong> {{ result.found }}</p>
                        {% if result.expected_value is defined %}
                        <p><strong>Expected Value:</strong> 
                            {% if result.expected_value is iterable and result.expected_value is not string %}
                                {% if result.expected_value|length > 5 %}
                                    <div class="expected-value-container">
                                        <span class="expected-value-truncated">[{{ result.expected_value[:5]|join(', ') }}, ... ({{ result.expected_value|length - 5 }} more)] 
                                            <button class="expand-btn" onclick="toggleExpectedValue(this)">Show More</button>
                                        </span>
                                        <span class="expected-value-full" style="display: none;">
                                            [{{ result.expected_value|join(', ') }}] 
                                            <button class="collapse-btn" onclick="toggleExpectedValue(this)">Show Less</button>
                                        </span>
                                    </div>
                                {% else %}
                                    [{{ result.expected_value|join(', ') }}]
                                {% endif %}
                            {% else %}
                                {{ result.expected_value }}
                            {% endif %}
                        </p>
                        {% endif %}
                        {% if result.policy_results %}
                        <div class="policy-breakdown">
                            <h4>Policy Details:</h4>
                            <ul>
                            {% for policy_result in result.policy_results %}
                                <li>{{ policy_result.policy_name }}: 
                                    {% if policy_result.is_compliant %}
                                        <span style="color: var(--success-color);">âœ“ COMPLIANT</span>
                                    {% else %}
                                        <span style="color: var(--danger-color);">âœ— NON-COMPLIANT</span>
                                    {% endif %}
                                    {% if policy_result.current_value is defined %}
                                        (Current: {{ policy_result.current_value }})
                                    {% endif %}
                                </li>
                            {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
    
    <script>
        // Toggle Expected Value Display
        function toggleExpectedValue(button) {
            const container = button.closest('.expected-value-container');
            const truncated = container.querySelector('.expected-value-truncated');
            const full = container.querySelector('.expected-value-full');
            
            if (truncated && full) {
                if (truncated.style.display === 'none') {
                    // Show truncated, hide full
                    truncated.style.display = 'inline';
                    full.style.display = 'none';
                } else {
                    // Show full, hide truncated
                    truncated.style.display = 'none';
                    full.style.display = 'inline';
                }
            }
        }

        // Enhanced Compliance Filter System
        class ComplianceFilter {
            constructor() {
                this.init();
            }
            
            init() {
                this.addDataAttributes();
                this.updateCounts();
                this.bindEventListeners();
                this.showAll(); // Start with all items visible
            }
            
            // Add data attributes to all policy items based on their status
            addDataAttributes() {
                const policyItems = document.querySelectorAll('.policy-item');
                const sectionCards = document.querySelectorAll('.section-card');
                
                policyItems.forEach(item => {
                    if (!item.hasAttribute('data-compliance')) {
                        const isCompliant = item.classList.contains('pass');
                        item.setAttribute('data-compliance', isCompliant ? 'compliant' : 'non-compliant');
                    }
                });
                
                // Add data-section attributes to section cards if they don't have them
                sectionCards.forEach((section, index) => {
                    if (!section.hasAttribute('data-section')) {
                        const heading = section.querySelector('.section-header h3');
                        if (heading) {
                            const sectionName = heading.textContent.toLowerCase()
                                .replace(/[^\w\s]/g, '') // Remove special characters
                                .replace(/\s+/g, '-'); // Replace spaces with dashes
                            section.setAttribute('data-section', sectionName);
                        } else {
                            section.setAttribute('data-section', `section-${index}`);
                        }
                    }
                });
            }
            
            // Update the count badges
            updateCounts() {
                const allItems = document.querySelectorAll('.policy-item').length;
                const compliantItems = document.querySelectorAll('.policy-item[data-compliance="compliant"]').length;
                const nonCompliantItems = allItems - compliantItems;
                
                document.getElementById('count-all').textContent = allItems;
                document.getElementById('count-compliant').textContent = compliantItems;
                document.getElementById('count-non-compliant').textContent = nonCompliantItems;
            }
            
            // Bind filter event listeners
            bindEventListeners() {
                const filterInputs = document.querySelectorAll('input[name="compliance-filter"]');
                filterInputs.forEach(input => {
                    input.addEventListener('change', (e) => {
                        const filterValue = e.target.value;
                        this.applyFilter(filterValue);
                    });
                });
            }
            
            // Apply the selected filter
            applyFilter(filterValue) {
                const policyItems = document.querySelectorAll('.policy-item');
                const sectionCards = document.querySelectorAll('.section-card');
                
                // Filter policy items
                policyItems.forEach(item => {
                    const compliance = item.getAttribute('data-compliance');
                    const shouldShow = filterValue === 'all' || compliance === filterValue;
                    
                    if (shouldShow) {
                        item.classList.remove('hidden');
                        item.classList.add('fade-in');
                    } else {
                        item.classList.add('hidden');
                        item.classList.remove('fade-in');
                    }
                });
                
                // Hide sections that have no visible items
                sectionCards.forEach(section => {
                    const visibleItems = section.querySelectorAll('.policy-item:not(.hidden)');
                    if (visibleItems.length === 0 && filterValue !== 'all') {
                        section.classList.add('hidden');
                    } else {
                        section.classList.remove('hidden');
                        section.classList.add('fade-in');
                    }
                });
                
                this.updateFilteredCounts(filterValue);
                this.updateScrollPosition();
            }
            
            // Update counts based on currently visible items
            updateFilteredCounts(activeFilter) {
                const visibleItems = document.querySelectorAll('.policy-item:not(.hidden)');
                const allItems = document.querySelectorAll('.policy-item').length;
                const compliantItems = document.querySelectorAll('.policy-item[data-compliance="compliant"]').length;
                const nonCompliantItems = allItems - compliantItems;
                
                // Update the active filter's count to show visible items
                if (activeFilter === 'all') {
                    document.getElementById('count-all').textContent = allItems;
                } else if (activeFilter === 'compliant') {
                    document.getElementById('count-compliant').textContent = compliantItems;
                } else if (activeFilter === 'non-compliant') {
                    document.getElementById('count-non-compliant').textContent = nonCompliantItems;
                }
            }
            
            // Smooth scroll to first visible item after filtering
            updateScrollPosition() {
                const firstVisibleItem = document.querySelector('.policy-item:not(.hidden)');
                if (firstVisibleItem) {
                    const filterControls = document.querySelector('.filter-controls');
                    const offset = filterControls ? filterControls.offsetHeight + 20 : 20;
                    
                    setTimeout(() => {
                        window.scrollTo({
                            top: firstVisibleItem.offsetTop - offset,
                            behavior: 'smooth'
                        });
                    }, 100);
                }
            }
            
            // Show all items (utility method)
            showAll() {
                this.applyFilter('all');
                document.getElementById('filter-all').checked = true;
            }
            
            // Show only compliant items (utility method)
            showCompliant() {
                this.applyFilter('compliant');
                document.getElementById('filter-compliant').checked = true;
            }
            
            // Show only non-compliant items (utility method)
            showNonCompliant() {
                this.applyFilter('non-compliant');
                document.getElementById('filter-non-compliant').checked = true;
            }
        }
        
        // Preset Policy Filter Class  
        class PresetPolicyFilter {
            constructor() {
                this.presetPolicyNames = [
                    // Microsoft's actual default preset policies
                    'Standard Preset Security Policy',
                    'Strict Preset Security Policy'
                    // Note: These can have random numbers appended in older tenants
                    // e.g., 'Standard Preset Security Policy1629904359847'
                    // Our detection logic handles both cases
                ];
                
                this.defaultPolicyNames = [
                    // Microsoft's default policies
                    'Default',
                    'Anti-malware Default Policy',
                    'Office365 AntiPhish Default',
                    'Built-In Protection Policy'
                ];
                
                this.originalStats = {
                    total: 0,
                    compliant: 0,
                    nonCompliant: 0,
                    percentage: 0
                };
                
                // Store original status texts
                this.originalStatusTexts = new Map();
                
                this.init();
            }
            
            init() {
                const presetToggle = document.getElementById('include-preset-policies');
                const defaultToggle = document.getElementById('include-default-policies');
                
                if (presetToggle) {
                    presetToggle.addEventListener('change', () => this.handleToggle());
                }
                if (defaultToggle) {
                    defaultToggle.addEventListener('change', () => this.handleToggle());
                }
                
                // Store original stats on first load
                this.storeOriginalStats();
            }
            
            storeOriginalStats() {
                // Store original executive summary stats - use more specific selectors
                const statItems = document.querySelectorAll('.summary-stats .stat-item');
                const totalElement = statItems[0]?.querySelector('.stat-number');
                const compliantElement = statItems[1]?.querySelector('.stat-number');
                const nonCompliantElement = statItems[2]?.querySelector('.stat-number');
                const percentageElement = statItems[3]?.querySelector('.stat-number');
                
                if (totalElement) this.originalStats.total = parseInt(totalElement.textContent);
                if (compliantElement) this.originalStats.compliant = parseInt(compliantElement.textContent);
                if (nonCompliantElement) this.originalStats.nonCompliant = parseInt(nonCompliantElement.textContent);
                if (percentageElement) this.originalStats.percentage = parseInt(percentageElement.textContent.replace('%', ''));
                
                // Store original status texts
                document.querySelectorAll('.status-text').forEach((span, index) => {
                    if (span.textContent.includes('Found in policies:')) {
                        this.originalStatusTexts.set(index, span.textContent);
                    }
                });
            }
            
            handleToggle() {
                const includePresets = document.getElementById('include-preset-policies').checked;
                const includeDefaults = document.getElementById('include-default-policies').checked;
                
                // Show all policies first
                this.showAllPolicies();
                
                // Then hide based on toggle states
                if (!includePresets) {
                    this.hidePresetPolicies();
                }
                if (!includeDefaults) {
                    this.hideDefaultPolicies();
                }
                
                this.recalculateStats(includePresets, includeDefaults);
                this.updateStatusTexts(includePresets, includeDefaults);
                
                // Update filter button counts to stay synchronized
                if (window.complianceFilter) {
                    window.complianceFilter.updateCounts();
                    console.log('ğŸ”§ Updated filter button counts after toggle change');
                }
                
                console.log(`ğŸ”§ Policies: Presets ${includePresets ? 'shown' : 'hidden'}, Defaults ${includeDefaults ? 'shown' : 'hidden'}`);
            }
            
            showAllPolicies() {
                // Show all previously hidden elements
                document.querySelectorAll('.preset-hidden, .default-hidden').forEach(element => {
                    element.style.display = '';
                    element.classList.remove('preset-hidden', 'default-hidden');
                });
                console.log('ğŸ”§ Showing all policies');
            }
            
            hidePresetPolicies() {
                let hiddenCount = 0;
                let hiddenPolicyItems = 0;
                
                // First, hide individual preset policy list items
                document.querySelectorAll('.policy-breakdown li').forEach(li => {
                    // Skip if already hidden
                    if (li.style.display === 'none') {
                        return;
                    }
                    
                    const text = li.textContent;
                    if (this.isPresetPolicy(text)) {
                        li.style.display = 'none';
                        li.classList.add('preset-hidden');
                        hiddenCount++;
                        console.log(`ğŸ”§ Hiding preset policy: ${text.substring(0, 50)}...`);
                    }
                });
                
                // Second, check main policy items by their titles
                document.querySelectorAll('.policy-item').forEach(item => {
                    // Skip if already hidden
                    if (item.style.display === 'none') {
                        return;
                    }
                    
                    const titleElement = item.querySelector('h4');
                    if (titleElement) {
                        const policyTitle = titleElement.textContent;
                        if (this.isPresetPolicy(policyTitle)) {
                            item.style.display = 'none';
                            item.classList.add('preset-hidden');
                            hiddenPolicyItems++;
                            console.log(`ğŸ”§ Hiding preset policy item: ${policyTitle}`);
                        }
                    }
                });
                
                // Third, hide entire policy-item divs that contain only preset policies
                this.hideEmptyPolicyItems('preset-hidden');
                
                console.log(`ğŸ”§ Hidden ${hiddenCount} individual preset policies and ${hiddenPolicyItems} preset policy items`);
            }
            
            hideDefaultPolicies() {
                let hiddenCount = 0;
                let hiddenPolicyItems = 0;
                
                // First, hide individual default policy list items
                document.querySelectorAll('.policy-breakdown li').forEach(li => {
                    // Skip if already hidden
                    if (li.style.display === 'none') {
                        return;
                    }
                    
                    const text = li.textContent;
                    if (this.isDefaultPolicy(text)) {
                        li.style.display = 'none';
                        li.classList.add('default-hidden');
                        hiddenCount++;
                        console.log(`ğŸ”§ Hiding default policy: ${text.substring(0, 50)}...`);
                    }
                });
                
                // Second, check main policy items by their titles
                document.querySelectorAll('.policy-item').forEach(item => {
                    // Skip if already hidden
                    if (item.style.display === 'none') {
                        return;
                    }
                    
                    const titleElement = item.querySelector('h4');
                    if (titleElement) {
                        const policyTitle = titleElement.textContent;
                        if (this.isDefaultPolicy(policyTitle)) {
                            item.style.display = 'none';
                            item.classList.add('default-hidden');
                            hiddenPolicyItems++;
                            console.log(`ğŸ”§ Hiding default policy item: ${policyTitle}`);
                        }
                    }
                });
                
                // Third, hide entire policy-item divs that contain only default policies
                this.hideEmptyPolicyItems('default-hidden');
                
                console.log(`ğŸ”§ Hidden ${hiddenCount} individual default policies and ${hiddenPolicyItems} default policy items`);
            }
            
            hideEmptyPolicyItems(hiddenClass) {
                let hiddenPolicyItems = 0;
                
                document.querySelectorAll('.policy-item').forEach(item => {
                    const breakdown = item.querySelector('.policy-breakdown ul');
                    if (breakdown) {
                        const allLis = breakdown.querySelectorAll('li');
                        const visibleLis = Array.from(allLis).filter(li => 
                            li.style.display !== 'none' && 
                            !li.classList.contains('preset-hidden') && 
                            !li.classList.contains('default-hidden')
                        );
                        
                        // If no policies are visible, hide the entire policy-item
                        if (allLis.length > 0 && visibleLis.length === 0) {
                            item.style.display = 'none';
                            item.classList.add(hiddenClass);
                            hiddenPolicyItems++;
                            const title = item.querySelector('h4');
                            if (title) {
                                console.log(`ğŸ”§ Hiding entire policy item: ${title.textContent}`);
                            }
                        }
                    }
                });
                
                return hiddenPolicyItems;
            }
            
            isPresetPolicy(text) {
                // Check for Microsoft's actual default preset policies only
                const lowerText = text.toLowerCase().trim();
                
                // Standard Preset Security Policy (with or without numbers)
                if (lowerText.includes('standard preset security policy')) {
                    return true;
                }
                
                // Strict Preset Security Policy (with or without numbers)  
                if (lowerText.includes('strict preset security policy')) {
                    return true;
                }
                
                return false;
            }
            
            isDefaultPolicy(text) {
                // Check for Microsoft's actual built-in default policies only
                const lowerText = text.toLowerCase().trim();
                
                // Exact match for "Default" followed by colon or end of string (for generic defaults)
                if (lowerText === 'default' || lowerText.startsWith('default:')) {
                    return true;
                }
                
                // Anti-malware Default Policy (Microsoft's built-in)
                if (lowerText.includes('anti-malware default policy')) {
                    return true;
                }
                
                // Office365 AntiPhish Default (Anti-phishing default policy)
                if (lowerText.includes('office365 antiphish default')) {
                    return true;
                }
                
                // Built-In Protection Policy (Safe Links & Safe Attachments default) - This is the key one!
                if (lowerText.includes('built-in protection policy')) {
                    return true;
                }
                
                // DO NOT include "Default Safe Links Policy" or "Default Safe Attachments Policy" 
                // as these are user-created policies that happen to have "default" in the name
                
                return false;
            }
            
            updateStatusTexts(includePresets, includeDefaults) {
                console.log(`ğŸ”„ Updating status texts: Presets=${includePresets}, Defaults=${includeDefaults}`);
                
                // If including both, restore original status texts
                if (includePresets && includeDefaults) {
                    document.querySelectorAll('.status-text').forEach((span, index) => {
                        if (this.originalStatusTexts.has(index)) {
                            span.textContent = this.originalStatusTexts.get(index);
                        }
                    });
                    return;
                }
                
                // Find all status text spans that mention policies
                document.querySelectorAll('.status-text').forEach((span, index) => {
                    // Start with original text if available
                    const originalText = this.originalStatusTexts.get(index) || span.textContent;
                    
                    if (originalText.includes('Found in policies:') || originalText.includes('COMPLIANT - Found in policies:')) {
                        
                        // Extract the policy list part
                        const parts = originalText.split('Found in policies:');
                        if (parts.length === 2) {
                            const beforeText = parts[0] + 'Found in policies:';
                            const policiesText = parts[1].trim();
                            
                            // Split policies by comma and filter them
                            const policies = policiesText.split(',').map(p => p.trim());
                            const filteredPolicies = policies.filter(policy => {
                                const lowerPolicy = policy.toLowerCase();
                                
                                // Check if this policy should be filtered out
                                if (!includePresets && this.isPresetPolicy(lowerPolicy)) {
                                    console.log(`ğŸ”„ Filtering preset policy from status: ${policy}`);
                                    return false;
                                }
                                
                                if (!includeDefaults && this.isDefaultPolicy(lowerPolicy)) {
                                    console.log(`ğŸ”„ Filtering default policy from status: ${policy}`);
                                    return false;
                                }
                                
                                return true;
                            });
                            
                            // Update the text
                            const newText = beforeText + ' ' + filteredPolicies.join(', ');
                            span.textContent = newText;
                            if (filteredPolicies.length !== policies.length) {
                                console.log(`ğŸ”„ Updated status text: ${newText}`);
                            }
                        }
                    }
                });
            }
            
            recalculateStats(includePresets, includeDefaults) {
                console.log(`ğŸ“Š Recalculating stats: Presets=${includePresets}, Defaults=${includeDefaults}`);
                
                if (includePresets && includeDefaults) {
                    // If including both, restore original stats
                    this.updateStatDisplay('.stat-number.total', this.originalStats.total);
                    this.updateStatDisplay('.stat-number.compliant', this.originalStats.compliant);
                    this.updateStatDisplay('.stat-number.non-compliant', this.originalStats.nonCompliant);
                    
                    // Update percentage
                    const percentageElement = document.querySelector('.summary-stats .stat-item:last-child .stat-number');
                    if (percentageElement) {
                        percentageElement.textContent = this.originalStats.percentage + '%';
                        this.updatePercentageColor(percentageElement, this.originalStats.percentage);
                    }
                    
                    // Update compliance bar
                    const complianceFill = document.querySelector('.compliance-fill');
                    if (complianceFill) {
                        complianceFill.style.width = this.originalStats.percentage + '%';
                    }
                    
                    console.log(`ğŸ“Š Stats restored: ${this.originalStats.compliant}/${this.originalStats.total} (${this.originalStats.percentage}%)`);
                    
                    // Update filter status indicator (no filtering active)
                    this.updateFilterStatusIndicator(includePresets, includeDefaults, 0);
                } else {
                    // Simple approach: count only visible policy items (not hidden by preset/default filters)
                    let totalChecks = 0;
                    let compliantChecks = 0;
                    let hiddenItems = 0;
                    
                    document.querySelectorAll('.policy-item').forEach(item => {
                        // Skip items that are completely hidden
                        if (item.style.display === 'none' || 
                            item.classList.contains('preset-hidden') || 
                            item.classList.contains('default-hidden') ||
                            item.classList.contains('hidden')) {
                            hiddenItems++;
                            return;
                        }
                        
                        // Count this policy item
                        totalChecks++;
                        const isCompliant = item.classList.contains('pass') || item.getAttribute('data-compliance') === 'compliant';
                        if (isCompliant) {
                            compliantChecks++;
                        }
                        
                        // Debug logging for first few items
                        if (totalChecks <= 5) {
                            const title = item.querySelector('h4')?.textContent || 'Unknown';
                            console.log(`ğŸ“Š Counting item ${totalChecks}: "${title}" - Compliant: ${isCompliant}`);
                        }
                    });
                    
                    const nonCompliantChecks = totalChecks - compliantChecks;
                    const percentage = totalChecks > 0 ? Math.round((compliantChecks / totalChecks) * 100) : 0;
                    
                    // Calculate what was hidden for better understanding
                    const hiddenTotal = this.originalStats.total - totalChecks;
                    const hiddenCompliant = this.originalStats.compliant - compliantChecks;
                    const hiddenNonCompliant = this.originalStats.nonCompliant - nonCompliantChecks;
                    
                    console.log(`ğŸ“Š Final counts: Total=${totalChecks}, Compliant=${compliantChecks}, Non-compliant=${nonCompliantChecks}, Hidden=${hiddenItems}`);
                    console.log(`ğŸ” Hidden analysis: ${hiddenTotal} total hidden (${hiddenCompliant} compliant, ${hiddenNonCompliant} non-compliant)`);
                    if (hiddenTotal > 0) {
                        const hiddenComplianceRate = Math.round((hiddenCompliant / hiddenTotal) * 100);
                        console.log(`ğŸ“ˆ Hidden policies were ${hiddenComplianceRate}% compliant, visible policies are ${percentage}% compliant`);
                    }
                    
                    // Update executive summary stats
                    this.updateStatDisplay('.stat-number.total', totalChecks);
                    this.updateStatDisplay('.stat-number.compliant', compliantChecks);
                    this.updateStatDisplay('.stat-number.non-compliant', nonCompliantChecks);
                    
                    // Update percentage with color coding
                    const percentageElement = document.querySelector('.summary-stats .stat-item:last-child .stat-number');
                    if (percentageElement) {
                        percentageElement.textContent = percentage + '%';
                        this.updatePercentageColor(percentageElement, percentage);
                    }
                    
                    // Update compliance bar
                    const complianceFill = document.querySelector('.compliance-fill');
                    if (complianceFill) {
                        complianceFill.style.width = percentage + '%';
                    }
                    
                    console.log(`ğŸ“Š Stats recalculated: ${compliantChecks}/${totalChecks} (${percentage}%) - Non-compliant: ${nonCompliantChecks}`);
                    console.log(`ğŸ“Š Filtered items: ${document.querySelectorAll('.policy-item.preset-hidden, .policy-item.default-hidden').length}`);
                    
                    // Update filter status indicator
                    this.updateFilterStatusIndicator(includePresets, includeDefaults, hiddenTotal);
                }
            }
            
            updatePercentageColor(element, percentage) {
                // Update percentage color class
                element.className = element.className.replace(/compliant|total|non-compliant/g, '');
                if (percentage >= 80) {
                    element.classList.add('compliant');
                } else if (percentage >= 60) {
                    element.classList.add('total');
                } else {
                    element.classList.add('non-compliant');
                }
            }
            
            updateStatDisplay(selector, value) {
                const element = document.querySelector(selector);
                if (element) {
                    element.textContent = value;
                }
            }
            
            updateFilterStatusIndicator(includePresets, includeDefaults, hiddenCount) {
                // Add or update a filter status indicator
                let indicator = document.querySelector('.filter-status-indicator');
                if (!indicator) {
                    indicator = document.createElement('div');
                    indicator.className = 'filter-status-indicator';
                    indicator.style.cssText = `
                        margin-top: 15px; 
                        padding: 10px 15px; 
                        background: var(--info-color); 
                        color: var(--text-white); 
                        border-radius: 6px; 
                        font-size: 13px; 
                        text-align: center;
                        font-weight: 600;
                    `;
                    const summaryCard = document.querySelector('.summary-card');
                    if (summaryCard) summaryCard.appendChild(indicator);
                }
                
                if (includePresets && includeDefaults) {
                    indicator.style.display = 'none';
                } else {
                    indicator.style.display = 'block';
                    const filterTypes = [];
                    if (!includePresets) filterTypes.push('Preset Policies');
                    if (!includeDefaults) filterTypes.push('Default Policies');
                    
                    indicator.innerHTML = `ğŸ” <strong>Filtered View:</strong> ${hiddenCount} policies hidden (${filterTypes.join(' + ')}). Statistics show only visible policies.`;
                }
            }
        }
        
        // Initialize the filter system when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ Starting filter system initialization...');
            
            // Force add toggle text if missing (emergency fix)
            const presetToggleText = document.querySelector('#include-preset-policies + label .toggle-text');
            const defaultToggleText = document.querySelector('#include-default-policies + label .toggle-text');
            
            if (presetToggleText && presetToggleText.innerHTML.trim() === '') {
                presetToggleText.innerHTML = '<span>ğŸ“‹ Include Microsoft Preset Policies</span><span class="toggle-info">(Standard & Strict Preset Security Policies)</span>';
                console.log('ğŸ”§ Fixed preset toggle text');
            }
            
            if (defaultToggleText && defaultToggleText.innerHTML.trim() === '') {
                defaultToggleText.innerHTML = '<span>âš™ï¸ Include Microsoft Default Policies</span><span class="toggle-info">(Default, Anti-malware Default Policy, Office365 AntiPhish Default, Built-In Protection Policy)</span>';
                console.log('ğŸ”§ Fixed default toggle text');
            }
            
            // Initialize filter systems
            window.complianceFilter = new ComplianceFilter();
            window.presetPolicyFilter = new PresetPolicyFilter();
            
            // Force update counts immediately
            setTimeout(() => {
                if (window.complianceFilter) {
                    window.complianceFilter.updateCounts();
                    console.log('ğŸ”§ Forced count update');
                }
            }, 100);
            
            // Add keyboard shortcuts for power users
            document.addEventListener('keydown', function(e) {
                // Alt + A = Show All
                if (e.altKey && e.key === 'a') {
                    e.preventDefault();
                    window.complianceFilter.showAll();
                }
                // Alt + C = Show Compliant
                else if (e.altKey && e.key === 'c') {
                    e.preventDefault();
                    window.complianceFilter.showCompliant();
                }
                // Alt + N = Show Non-Compliant
                else if (e.altKey && e.key === 'n') {
                    e.preventDefault();
                    window.complianceFilter.showNonCompliant();
                }
                // Alt + P = Toggle Preset Policies
                else if (e.altKey && e.key === 'p') {
                    e.preventDefault();
                    const toggle = document.getElementById('include-preset-policies');
                    if (toggle) {
                        toggle.checked = !toggle.checked;
                        toggle.dispatchEvent(new Event('change'));
                    }
                }
                // Alt + D = Toggle Default Policies
                else if (e.altKey && e.key === 'd') {
                    e.preventDefault();
                    const toggle = document.getElementById('include-default-policies');
                    if (toggle) {
                        toggle.checked = !toggle.checked;
                        toggle.dispatchEvent(new Event('change'));
                    }
                }
            });
            
            console.log('ğŸ” Compliance Filter System Initialized');
            console.log('ğŸ”§ Preset Policy Filter System Initialized');
            console.log('ğŸ’¡ Keyboard shortcuts: Alt+A (All), Alt+C (Compliant), Alt+N (Non-Compliant), Alt+P (Toggle Presets), Alt+D (Toggle Defaults)');
        });
    </script>
</body>
</html>

