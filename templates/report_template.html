<!DOCTYPE html>
<html>
<head>
    <title>Posture Assessment Tool Report</title>
    <style>
        @import url(https://fonts.googleapis.com/css?family=Nunito+Sans);
        @import url(https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap);
        
        :root {
            /* CriticalStart Theme Colors */
            --primary-color: #009cde;
            --primary-dark: #0c4c70;
            --background-dark: #141827;
            --surface-dark: #1b2032;
            --surface-light: #2a2f45;
            --border-color: #4e586a;
            --text-white: #fff;
            --text-light: #d1d1d1;
            
            /* Status Colors from CriticalStart CSS */
            --success-color: #28a745;
            --warning-color: #ffc107;
            --warning-text: #000;
            --danger-color: #dc3545;
            --info-color: #6f42c1;
            --orange-color: #fd7e14;
        }
        
        body {
            font-family: 'Nunito Sans', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-dark);
            color: var(--text-white);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-color) 100%);
            color: var(--text-white);
            padding: 30px 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .header h1 {
            margin: 0;
            font-size: 32px;
            font-weight: 600;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .timestamp {
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
            margin-top: 10px;
        }
        
        .tenant-info {
            color: rgba(255, 255, 255, 0.95);
            font-size: 16px;
            margin: 15px 0 10px 0;
            padding: 10px 0;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .summary-card {
            background: var(--surface-dark);
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
        }
        
        .summary-card h2 {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 24px;
            font-weight: 600;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-item {
            background: var(--surface-light);
            padding: 20px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid var(--border-color);
            transition: transform 0.2s ease;
        }
        
        .stat-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }
        
        .stat-number {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 5px;
            font-family: 'Roboto Mono', monospace;
        }
        
        .stat-number.compliant {
            color: var(--success-color);
        }
        
        .stat-number.non-compliant {
            color: var(--danger-color);
        }
        
        .stat-number.total {
            color: var(--primary-color);
        }
        
        .stat-label {
            font-size: 14px;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .compliance-bar {
            width: 100%;
            height: 20px;
            background: var(--surface-light);
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
            border: 1px solid var(--border-color);
        }
        
        .compliance-fill {
            height: 100%;
            transition: width 0.3s ease;
            background: linear-gradient(90deg, var(--success-color) 0%, var(--primary-color) 100%);
        }
        
        .section-card {
            background: var(--surface-dark);
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }
        
        .section-header {
            background: var(--surface-light);
            padding: 20px 25px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .section-header h3 {
            margin: 0;
            color: var(--primary-color);
            font-size: 20px;
            font-weight: 600;
        }
        
        .section-content {
            padding: 25px;
        }
        
        .policy-item {
            background: var(--surface-light);
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid var(--border-color);
            transition: all 0.2s ease;
        }
        
        .policy-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .policy-item.pass {
            border-left-color: var(--success-color);
            background: linear-gradient(135deg, var(--surface-light) 0%, rgba(40, 167, 69, 0.1) 100%);
        }
        
        .policy-item.fail {
            border-left-color: var(--danger-color);
            background: linear-gradient(135deg, var(--surface-light) 0%, rgba(220, 53, 69, 0.1) 100%);
        }
        
        .policy-item h4 {
            margin: 0 0 15px 0;
            color: var(--text-white);
            font-size: 16px;
            font-weight: 600;
        }
        
        .policy-status-banner {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 12px;
            margin-bottom: 15px;
            display: inline-block;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .policy-status-banner.pass {
            background-color: var(--success-color);
            color: var(--text-white);
        }
        
        .policy-status-banner.fail {
            background-color: var(--danger-color);
            color: var(--text-white);
        }
        
        .policy-details {
            margin-top: 15px;
            padding: 15px;
            background: var(--background-dark);
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }
        
        .policy-details.pass {
            border-left: 3px solid var(--success-color);
        }
        
        .policy-details.fail {
            border-left: 3px solid var(--danger-color);
        }
        
        .policy-description {
            margin: 10px 0;
            padding: 8px 12px;
            background: var(--background-dark);
            border-left: 3px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-secondary);
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        .status-text {
            font-weight: 600;
            font-family: 'Roboto Mono', monospace;
        }
        
        .status-text.pass {
            color: var(--success-color);
        }
        
        .status-text.fail {
            color: var(--danger-color);
        }
        
        .policy-breakdown {
            margin-top: 15px;
            padding: 15px;
            background: var(--background-dark);
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }
        
        .policy-breakdown h4 {
            margin: 0 0 10px 0;
            color: var(--primary-color);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .policy-breakdown ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .policy-breakdown li {
            margin-bottom: 8px;
            color: var(--text-light);
        }
        
        /* CriticalStart Status Classes */
        .severity-high {
            background-color: var(--danger-color);
            color: var(--text-white);
            padding: 5px 10px;
            border-radius: 4px;
            text-align: center;
            font-weight: 600;
        }
        
        .severity-medium {
            background-color: var(--orange-color);
            color: var(--text-white);
            padding: 5px 10px;
            border-radius: 4px;
            text-align: center;
            font-weight: 600;
        }
        
        .severity-low {
            background-color: var(--warning-color);
            color: var(--warning-text);
            padding: 5px 10px;
            border-radius: 4px;
            text-align: center;
            font-weight: 600;
        }
        
        .severity-info {
            background-color: var(--info-color);
            color: var(--text-white);
            padding: 5px 10px;
            border-radius: 4px;
            text-align: center;
            font-weight: 600;
        }
        
        .status-approved {
            background-color: var(--success-color);
            color: var(--text-white);
            padding: 5px 10px;
            border-radius: 4px;
            text-align: center;
            font-weight: 600;
        }
        
        .status-draft {
            background-color: var(--warning-color);
            color: var(--warning-text);
            padding: 5px 10px;
            border-radius: 4px;
            text-align: center;
            font-weight: 600;
        }
        
        .status-expired {
            background-color: var(--danger-color);
            color: var(--text-white);
            padding: 5px 10px;
            border-radius: 4px;
            text-align: center;
            font-weight: 600;
        }
        
        /* Scrollbar Styling for Dark Theme */
        ::-webkit-scrollbar {
            width: 12px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--background-dark);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }
        
        /* Filter Controls */
        .filter-controls {
            background: var(--surface-dark);
            padding: 20px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .filter-controls h3 {
            margin: 0 0 20px 0;
            color: var(--primary-color);
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .filter-switches {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-switch {
            position: relative;
        }
        
        .filter-switch input[type="radio"] {
            display: none;
        }
        
        .filter-label {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: var(--surface-light);
            border: 2px solid var(--border-color);
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            user-select: none;
        }
        
        .filter-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }
        
        .filter-switch input[type="radio"]:checked + .filter-label {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            border-color: var(--primary-color);
            color: var(--text-white);
            box-shadow: 0 4px 8px rgba(0, 156, 222, 0.3);
        }
        
        .filter-switch input[type="radio"]:checked + .filter-label.compliant-filter {
            background: linear-gradient(135deg, var(--success-color) 0%, #1e6b2e 100%);
            border-color: var(--success-color);
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
        }
        
        .filter-switch input[type="radio"]:checked + .filter-label.non-compliant-filter {
            background: linear-gradient(135deg, var(--danger-color) 0%, #a02622 100%);
            border-color: var(--danger-color);
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
        }
        
        .filter-icon {
            font-size: 16px;
        }
        
        .filter-count {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .filter-switch input[type="radio"]:checked + .filter-label .filter-count {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* Hidden items animation */
        .policy-item.hidden {
            display: none !important;
        }
        
        .section-card.hidden {
            display: none !important;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Expected Value Expand/Collapse Styles */
        .expected-value-container {
            display: inline-block;
        }
        
        .expand-btn, .collapse-btn {
            background: var(--primary-color);
            color: var(--text-white);
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s ease;
            margin: 0 2px;
        }
        
        .expand-btn:hover, .collapse-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .expected-value-full {
            word-break: break-all;
            line-height: 1.4;
        }

        /* Print Styles */
        @media print {
            body {
                background-color: white;
                color: black;
            }
            
            .header {
                background: var(--primary-color) !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .summary-card, .section-card, .policy-item {
                background: white !important;
                border: 1px solid #ddd !important;
                color: black !important;
            }
            
            .filter-controls {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>🛡️ Posture Assessment Tool Report</h1>
            {% if tenant_info and (tenant_info.displayName or tenant_info.id) %}
            <div class="tenant-info">
                <strong>🏢 {{ tenant_info.displayName or 'Unknown Organization' }}</strong>
                {% set tenant_id = tenant_info.id or tenant_info.tenantId %}
                {% if tenant_id and tenant_id != 'Unknown' %}
                <span style="margin-left: 20px;">🆔 Tenant ID: {{ tenant_id }}</span>
                {% endif %}
            </div>
            {% endif %}
            <div class="timestamp">📅 Generated: {{ timestamp }}</div>
        </div>
    </div>

    <div class="container">
        <div class="summary-card">
            <h2>📊 Executive Summary</h2>
            
            <div class="summary-stats">
                <div class="stat-item">
                    <div class="stat-number total">{{ (ca_compliance.total if ca_compliance else 0) + (auth_compliance.total if auth_compliance else 0) + (antispam_inbound_standard_compliance.total if antispam_inbound_standard_compliance else 0) + (antispam_inbound_strict_compliance.total if antispam_inbound_strict_compliance else 0) + (antispam_outbound_compliance.total if antispam_outbound_compliance else 0) + (antiphishing_standard_compliance.total if antiphishing_standard_compliance else 0) + (antiphishing_strict_compliance.total if antiphishing_strict_compliance else 0) + (antimalware_compliance.total if antimalware_compliance else 0) + (safeattachments_compliance.total if safeattachments_compliance else 0) + (safelinks_compliance.total if safelinks_compliance else 0) + (exchangeonline_compliance.total if exchangeonline_compliance else 0) + (dns_compliance.total if dns_compliance else 0) + (antivirus_compliance.total if antivirus_compliance else 0) + (asr_compliance.total if asr_compliance else 0) }}</div>
                    <div class="stat-label">Total Checks</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number compliant">{{ (ca_compliance.passed if ca_compliance else 0) + (auth_compliance.passed if auth_compliance else 0) + (antispam_inbound_standard_compliance.passed if antispam_inbound_standard_compliance else 0) + (antispam_inbound_strict_compliance.passed if antispam_inbound_strict_compliance else 0) + (antispam_outbound_compliance.passed if antispam_outbound_compliance else 0) + (antiphishing_standard_compliance.passed if antiphishing_standard_compliance else 0) + (antiphishing_strict_compliance.passed if antiphishing_strict_compliance else 0) + (antimalware_compliance.passed if antimalware_compliance else 0) + (safeattachments_compliance.passed if safeattachments_compliance else 0) + (safelinks_compliance.passed if safelinks_compliance else 0) + (exchangeonline_compliance.passed if exchangeonline_compliance else 0) + (dns_compliance.passed if dns_compliance else 0) + (antivirus_compliance.passed if antivirus_compliance else 0) + (asr_compliance.passed if asr_compliance else 0) }}</div>
                    <div class="stat-label">Compliant</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number non-compliant">{{ ((ca_compliance.total if ca_compliance else 0) + (auth_compliance.total if auth_compliance else 0) + (antispam_inbound_standard_compliance.total if antispam_inbound_standard_compliance else 0) + (antispam_inbound_strict_compliance.total if antispam_inbound_strict_compliance else 0) + (antispam_outbound_compliance.total if antispam_outbound_compliance else 0) + (antiphishing_standard_compliance.total if antiphishing_standard_compliance else 0) + (antiphishing_strict_compliance.total if antiphishing_strict_compliance else 0) + (antimalware_compliance.total if antimalware_compliance else 0) + (safeattachments_compliance.total if safeattachments_compliance else 0) + (safelinks_compliance.total if safelinks_compliance else 0) + (exchangeonline_compliance.total if exchangeonline_compliance else 0) + (dns_compliance.total if dns_compliance else 0) + (antivirus_compliance.total if antivirus_compliance else 0) + (asr_compliance.total if asr_compliance else 0)) - ((ca_compliance.passed if ca_compliance else 0) + (auth_compliance.passed if auth_compliance else 0) + (antispam_inbound_standard_compliance.passed if antispam_inbound_standard_compliance else 0) + (antispam_inbound_strict_compliance.passed if antispam_inbound_strict_compliance else 0) + (antispam_outbound_compliance.passed if antispam_outbound_compliance else 0) + (antiphishing_standard_compliance.passed if antiphishing_standard_compliance else 0) + (antiphishing_strict_compliance.passed if antiphishing_strict_compliance else 0) + (antimalware_compliance.passed if antimalware_compliance else 0) + (safeattachments_compliance.passed if safeattachments_compliance else 0) + (safelinks_compliance.passed if safelinks_compliance else 0) + (exchangeonline_compliance.passed if exchangeonline_compliance else 0) + (dns_compliance.passed if dns_compliance else 0) + (antivirus_compliance.passed if antivirus_compliance else 0) + (asr_compliance.passed if asr_compliance else 0)) }}</div>
                    <div class="stat-label">Non-Compliant</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number {% if compliance_percentage >= 80 %}compliant{% elif compliance_percentage >= 60 %}total{% else %}non-compliant{% endif %}">{{ compliance_percentage }}%</div>
                    <div class="stat-label">Compliance Rate</div>
                </div>
            </div>
            
            <div class="compliance-bar">
                <div class="compliance-fill" style="width: {{ compliance_percentage }}%"></div>
            </div>
            
            <!-- Section-by-Section Compliance Breakdown -->
            <div style="margin-top: 30px;">
                <h3 style="color: var(--primary-color); margin-bottom: 20px; font-size: 18px;">📋 Compliance Breakdown by Category</h3>
                
                {% if ca_compliance %}
                <div class="compliance-indicator" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; margin-bottom: 12px; background: var(--surface-light); border-radius: 8px; border-left: 4px solid {% if ca_compliance.is_compliant %}var(--success-color){% else %}var(--danger-color){% endif %};">
                    <div style="flex: 1;">
                        <span style="font-weight: 600; color: var(--text-white);">🔐 Conditional Access Policies</span>
                        <div style="font-size: 12px; color: var(--text-light); margin-top: 4px;">({{ ca_compliance.passed }}/{{ ca_compliance.total }} Passed)</div>
                    </div>
                    <div style="text-align: right;">
                        <span class="{% if ca_compliance.is_compliant %}status-approved{% else %}status-expired{% endif %}" style="display: inline-block; margin-bottom: 5px;">
                            {% if ca_compliance.is_compliant %}✅ COMPLIANT{% else %}❌ NON-COMPLIANT{% endif %}
                        </span>
                        <div style="font-size: 14px; font-weight: bold; color: var(--text-white);">{{ ca_compliance.percentage }}%</div>
                    </div>
                </div>
                {% endif %}
                
                {% if auth_compliance %}
                <div class="compliance-indicator" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; margin-bottom: 12px; background: var(--surface-light); border-radius: 8px; border-left: 4px solid {% if auth_compliance.is_compliant %}var(--success-color){% else %}var(--danger-color){% endif %};">
                    <div style="flex: 1;">
                        <span style="font-weight: 600; color: var(--text-white);">🛡️ Authorization Policies</span>
                        <div style="font-size: 12px; color: var(--text-light); margin-top: 4px;">({{ auth_compliance.passed }}/{{ auth_compliance.total }} Passed)</div>
                    </div>
                    <div style="text-align: right;">
                        <span class="{% if auth_compliance.is_compliant %}status-approved{% else %}status-expired{% endif %}" style="display: inline-block; margin-bottom: 5px;">
                            {% if auth_compliance.is_compliant %}✅ COMPLIANT{% else %}❌ NON-COMPLIANT{% endif %}
                        </span>
                        <div style="font-size: 14px; font-weight: bold; color: var(--text-white);">{{ auth_compliance.percentage }}%</div>
                    </div>
                </div>
                {% endif %}
                
                {% if antispam_compliance %}
                <div class="compliance-indicator" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; margin-bottom: 12px; background: var(--surface-light); border-radius: 8px; border-left: 4px solid {% if antispam_inbound_standard_compliance.is_compliant %}var(--success-color){% else %}var(--danger-color){% endif %};">
                    <div style="flex: 1;">
                        <span style="font-weight: 600; color: var(--text-white);">📧 Anti-Spam Inbound Standard</span>
                        <div style="font-size: 12px; color: var(--text-light); margin-top: 4px;">({{ antispam_inbound_standard_compliance.passed }}/{{ antispam_inbound_standard_compliance.total }} Passed)</div>
                        {% if antispam_inbound_standard_compliance.is_compliant and antispam_inbound_standard_compliance.compliant_policy %}
                        <div style="font-size: 11px; color: var(--success-color); margin-top: 4px; font-style: italic;">✓ Policy "{{ antispam_inbound_standard_compliance.compliant_policy }}" meets all requirements</div>
                        {% endif %}
                    </div>
                    <div style="text-align: right;">
                        <span class="{% if antispam_inbound_standard_compliance.is_compliant %}status-approved{% else %}status-expired{% endif %}" style="display: inline-block; margin-bottom: 5px;">
                            {% if antispam_inbound_standard_compliance.is_compliant %}✅ COMPLIANT{% else %}❌ NON-COMPLIANT{% endif %}
                        </span>
                        <div style="font-size: 14px; font-weight: bold; color: var(--text-white);">{{ antispam_inbound_standard_compliance.percentage }}%</div>
                    </div>
                </div>
                {% endif %}
                
                {% if antiphishing_compliance %}
                <div class="compliance-indicator" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; margin-bottom: 12px; background: var(--surface-light); border-radius: 8px; border-left: 4px solid {% if antiphishing_standard_compliance.is_compliant %}var(--success-color){% else %}var(--danger-color){% endif %};">
                    <div style="flex: 1;">
                        <span style="font-weight: 600; color: var(--text-white);">🎣 Anti-Phishing Policies</span>
                        <div style="font-size: 12px; color: var(--text-light); margin-top: 4px;">({{ antiphishing_standard_compliance.passed }}/{{ antiphishing_standard_compliance.total }} Passed)</div>
                        {% if antiphishing_standard_compliance.is_compliant and antiphishing_standard_compliance.compliant_policy %}
                        <div style="font-size: 11px; color: var(--success-color); margin-top: 4px; font-style: italic;">✓ Policy "{{ antiphishing_standard_compliance.compliant_policy }}" meets all requirements</div>
                        {% endif %}
                    </div>
                    <div style="text-align: right;">
                        <span class="{% if antiphishing_standard_compliance.is_compliant %}status-approved{% else %}status-expired{% endif %}" style="display: inline-block; margin-bottom: 5px;">
                            {% if antiphishing_standard_compliance.is_compliant %}✅ COMPLIANT{% else %}❌ NON-COMPLIANT{% endif %}
                        </span>
                        <div style="font-size: 14px; font-weight: bold; color: var(--text-white);">{{ antiphishing_standard_compliance.percentage }}%</div>
                    </div>
                </div>
                {% endif %}
                
                {% if antimalware_compliance %}
                <div class="compliance-indicator" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; margin-bottom: 12px; background: var(--surface-light); border-radius: 8px; border-left: 4px solid {% if antimalware_compliance.is_compliant %}var(--success-color){% else %}var(--danger-color){% endif %};">
                    <div style="flex: 1;">
                        <span style="font-weight: 600; color: var(--text-white);">🦠 Anti-Malware Policies</span>
                        <div style="font-size: 12px; color: var(--text-light); margin-top: 4px;">({{ antimalware_compliance.passed }}/{{ antimalware_compliance.total }} Passed)</div>
                        {% if antimalware_compliance.is_compliant and antimalware_compliance.compliant_policy %}
                        <div style="font-size: 11px; color: var(--success-color); margin-top: 4px; font-style: italic;">✓ Policy "{{ antimalware_compliance.compliant_policy }}" meets all requirements</div>
                        {% endif %}
                    </div>
                    <div style="text-align: right;">
                        <span class="{% if antimalware_compliance.is_compliant %}status-approved{% else %}status-expired{% endif %}" style="display: inline-block; margin-bottom: 5px;">
                            {% if antimalware_compliance.is_compliant %}✅ COMPLIANT{% else %}❌ NON-COMPLIANT{% endif %}
                        </span>
                        <div style="font-size: 14px; font-weight: bold; color: var(--text-white);">{{ antimalware_compliance.percentage }}%</div>
                    </div>
                </div>
                {% endif %}
                
                {% if safeattachments_compliance %}
                <div class="compliance-indicator" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; margin-bottom: 12px; background: var(--surface-light); border-radius: 8px; border-left: 4px solid {% if safeattachments_compliance.is_compliant %}var(--success-color){% else %}var(--danger-color){% endif %};">
                    <div style="flex: 1;">
                        <span style="font-weight: 600; color: var(--text-white);">📎 Safe Attachments Policies</span>
                        <div style="font-size: 12px; color: var(--text-light); margin-top: 4px;">({{ safeattachments_compliance.passed }}/{{ safeattachments_compliance.total }} Passed)</div>
                        {% if safeattachments_compliance.is_compliant and safeattachments_compliance.compliant_policy %}
                        <div style="font-size: 11px; color: var(--success-color); margin-top: 4px; font-style: italic;">✓ Policy "{{ safeattachments_compliance.compliant_policy }}" meets all requirements</div>
                        {% endif %}
                    </div>
                    <div style="text-align: right;">
                        <span class="{% if safeattachments_compliance.is_compliant %}status-approved{% else %}status-expired{% endif %}" style="display: inline-block; margin-bottom: 5px;">
                            {% if safeattachments_compliance.is_compliant %}✅ COMPLIANT{% else %}❌ NON-COMPLIANT{% endif %}
                        </span>
                        <div style="font-size: 14px; font-weight: bold; color: var(--text-white);">{{ safeattachments_compliance.percentage }}%</div>
                    </div>
                </div>
                {% endif %}
                
                {% if safelinks_compliance %}
                <div class="compliance-indicator" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; margin-bottom: 12px; background: var(--surface-light); border-radius: 8px; border-left: 4px solid {% if safelinks_compliance.is_compliant %}var(--success-color){% else %}var(--danger-color){% endif %};">
                    <div style="flex: 1;">
                        <span style="font-weight: 600; color: var(--text-white);">🔗 Safe Links Policies</span>
                        <div style="font-size: 12px; color: var(--text-light); margin-top: 4px;">({{ safelinks_compliance.passed }}/{{ safelinks_compliance.total }} Passed)</div>
                        {% if safelinks_compliance.is_compliant and safelinks_compliance.compliant_policy %}
                        <div style="font-size: 11px; color: var(--success-color); margin-top: 4px; font-style: italic;">✓ Policy "{{ safelinks_compliance.compliant_policy }}" meets all requirements</div>
                        {% endif %}
                    </div>
                    <div style="text-align: right;">
                        <span class="{% if safelinks_compliance.is_compliant %}status-approved{% else %}status-expired{% endif %}" style="display: inline-block; margin-bottom: 5px;">
                            {% if safelinks_compliance.is_compliant %}✅ COMPLIANT{% else %}❌ NON-COMPLIANT{% endif %}
                        </span>
                        <div style="font-size: 14px; font-weight: bold; color: var(--text-white);">{{ safelinks_compliance.percentage }}%</div>
                    </div>
                </div>
                {% endif %}
                
                {% if exchangeonline_compliance %}
                <div class="compliance-indicator" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; margin-bottom: 12px; background: var(--surface-light); border-radius: 8px; border-left: 4px solid {% if exchangeonline_compliance.is_compliant %}var(--success-color){% else %}var(--danger-color){% endif %};">
                    <div style="flex: 1;">
                        <span style="font-weight: 600; color: var(--text-white);">📨 Exchange Online Configurations</span>
                        <div style="font-size: 12px; color: var(--text-light); margin-top: 4px;">({{ exchangeonline_compliance.passed }}/{{ exchangeonline_compliance.total }} Passed)</div>
                        {% if exchangeonline_compliance.is_compliant and exchangeonline_compliance.compliant_policy %}
                        <div style="font-size: 11px; color: var(--success-color); margin-top: 4px; font-style: italic;">✓ All general settings meet requirements</div>
                        {% endif %}
                    </div>
                    <div style="text-align: right;">
                        <span class="{% if exchangeonline_compliance.is_compliant %}status-approved{% else %}status-expired{% endif %}" style="display: inline-block; margin-bottom: 5px;">
                            {% if exchangeonline_compliance.is_compliant %}✅ COMPLIANT{% else %}❌ NON-COMPLIANT{% endif %}
                        </span>
                        <div style="font-size: 14px; font-weight: bold; color: var(--text-white);">{{ exchangeonline_compliance.percentage }}%</div>
                    </div>
                </div>
                {% endif %}
                
                {% if dns_compliance %}
                <div class="compliance-indicator" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; margin-bottom: 12px; background: var(--surface-light); border-radius: 8px; border-left: 4px solid {% if dns_compliance.is_compliant %}var(--success-color){% else %}var(--danger-color){% endif %};">
                    <div style="flex: 1;">
                        <span style="font-weight: 600; color: var(--text-white);">🌐 DNS Security Configurations</span>
                        <div style="font-size: 12px; color: var(--text-light); margin-top: 4px;">({{ dns_compliance.passed }}/{{ dns_compliance.total }} Passed)</div>
                    </div>
                    <div style="text-align: right;">
                        <span class="{% if dns_compliance.is_compliant %}status-approved{% else %}status-expired{% endif %}" style="display: inline-block; margin-bottom: 5px;">
                            {% if dns_compliance.is_compliant %}✅ COMPLIANT{% else %}❌ NON-COMPLIANT{% endif %}
                        </span>
                        <div style="font-size: 14px; font-weight: bold; color: var(--text-white);">{{ dns_compliance.percentage }}%</div>
                    </div>
                </div>
                {% endif %}
                
                {% if antivirus_compliance %}
                <div class="compliance-indicator" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; margin-bottom: 12px; background: var(--surface-light); border-radius: 8px; border-left: 4px solid {% if antivirus_compliance.is_compliant %}var(--success-color){% else %}var(--danger-color){% endif %};">
                    <div style="flex: 1;">
                        <span style="font-weight: 600; color: var(--text-white);">🛡️ Defender Antivirus</span>
                        <div style="font-size: 12px; color: var(--text-light); margin-top: 4px;">({{ antivirus_compliance.passed }}/{{ antivirus_compliance.total }} Passed)</div>
                        {% if antivirus_compliance.is_compliant and antivirus_compliance.compliant_policy %}
                        <div style="font-size: 11px; color: var(--success-color); margin-top: 4px; font-style: italic;">✓ Policy "{{ antivirus_compliance.compliant_policy }}" meets all requirements</div>
                        {% endif %}
                    </div>
                    <div style="text-align: right;">
                        <span class="{% if antivirus_compliance.is_compliant %}status-approved{% else %}status-expired{% endif %}" style="display: inline-block; margin-bottom: 5px;">
                            {% if antivirus_compliance.is_compliant %}✅ COMPLIANT{% else %}❌ NON-COMPLIANT{% endif %}
                        </span>
                        <div style="font-size: 14px; font-weight: bold; color: var(--text-white);">{{ antivirus_compliance.percentage }}%</div>
                    </div>
                </div>
                {% endif %}
                
                {% if asr_compliance %}
                <div class="compliance-indicator" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; margin-bottom: 12px; background: var(--surface-light); border-radius: 8px; border-left: 4px solid {% if asr_compliance.is_compliant %}var(--success-color){% else %}var(--danger-color){% endif %};">
                    <div style="flex: 1;">
                        <span style="font-weight: 600; color: var(--text-white);">🔒 Attack Surface Reduction</span>
                        <div style="font-size: 12px; color: var(--text-light); margin-top: 4px;">({{ asr_compliance.passed }}/{{ asr_compliance.total }} Passed)</div>
                        {% if asr_compliance.is_compliant and asr_compliance.compliant_policy %}
                        <div style="font-size: 11px; color: var(--success-color); margin-top: 4px; font-style: italic;">✓ Policy "{{ asr_compliance.compliant_policy }}" meets all requirements</div>
                        {% endif %}
                    </div>
                    <div style="text-align: right;">
                        <span class="{% if asr_compliance.is_compliant %}status-approved{% else %}status-expired{% endif %}" style="display: inline-block; margin-bottom: 5px;">
                            {% if asr_compliance.is_compliant %}✅ COMPLIANT{% else %}❌ NON-COMPLIANT{% endif %}
                        </span>
                        <div style="font-size: 14px; font-weight: bold; color: var(--text-white);">{{ asr_compliance.percentage }}%</div>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <p style="text-align: center; margin-top: 25px; color: var(--text-light); font-size: 16px; font-weight: 500;">
                {% if compliance_percentage >= 90 %}
                    🏆 Excellent security posture! Your organization demonstrates strong adherence to security best practices.
                {% elif compliance_percentage >= 80 %}
                    ✅ Good security posture with room for minor improvements.
                {% elif compliance_percentage >= 60 %}
                    ⚠️ Moderate security posture. Several areas need attention to improve security stance.
                {% else %}
                    🚨 Security posture needs significant improvement. Multiple critical issues require immediate attention.
                {% endif %}
            </p>
        </div>

        <!-- Filter Controls -->
        <div class="filter-controls">
            <h3><span class="filter-icon">🔍</span> Filter Results</h3>
            <div class="filter-switches">
                <div class="filter-switch">
                    <input type="radio" id="filter-all" name="compliance-filter" value="all" checked>
                    <label for="filter-all" class="filter-label">
                        <span class="filter-icon">📋</span>
                        <span>Show All</span>
                        <span class="filter-count" id="count-all">0</span>
                    </label>
                </div>
                <div class="filter-switch">
                    <input type="radio" id="filter-compliant" name="compliance-filter" value="compliant">
                    <label for="filter-compliant" class="filter-label compliant-filter">
                        <span class="filter-icon">✅</span>
                        <span>Compliant Only</span>
                        <span class="filter-count" id="count-compliant">0</span>
                    </label>
                </div>
                <div class="filter-switch">
                    <input type="radio" id="filter-non-compliant" name="compliance-filter" value="non-compliant">
                    <label for="filter-non-compliant" class="filter-label non-compliant-filter">
                        <span class="filter-icon">❌</span>
                        <span>Non-Compliant Only</span>
                        <span class="filter-count" id="count-non-compliant">0</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Conditional Access Policies -->
        {% if ca_results %}
        <div class="section-card" data-section="conditional-access">
            <div class="section-header">
                <h3>🔐 Entra ID Conditional Access Policies</h3>
            </div>
            <div class="section-content">
                {% for result in ca_results %}
                {% set status = result.status %}
                {% set is_compliant = status.startswith('COMPLIANT') or (result.found and not status.startswith('NON-COMPLIANT') and 'ERROR' not in status) %}
                <div class="policy-item {% if is_compliant %}pass{% else %}fail{% endif %}" data-compliance="{% if is_compliant %}compliant{% else %}non-compliant{% endif %}">
                    <div class="policy-status-banner {% if is_compliant %}pass{% else %}fail{% endif %}">
                        {% if is_compliant %}✅ COMPLIANT{% else %}❌ NON-COMPLIANT{% endif %}
                    </div>
                    <h4>{{ result.check_id }} - {{ result.requirement_name }}</h4>
                    {% if result.description %}
                    <p class="policy-description"><em>{{ result.description }}</em></p>
                    {% endif %}
                    <div class="policy-details {% if is_compliant %}pass{% else %}fail{% endif %}">
                        <p><strong>Status:</strong> <span class="status-text {% if is_compliant %}pass{% else %}fail{% endif %}">{{ result.status }}</span></p>
                        <p><strong>Policy Found:</strong> {{ result.found }}</p>
                        {% if result.expected_value is defined %}
                        <p><strong>Expected Configuration:</strong> {{ result.expected_value }}</p>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Authorization Policy -->
        {% if auth_results %}
        <div class="section-card" data-section="authorization">
            <div class="section-header">
                <h3>🛡️ Entra ID Authorization Policies</h3>
            </div>
            <div class="section-content">
                {% for result in auth_results %}
                {% set status = result.status %}
                {% if result.is_compliant is defined %}
                    {% set is_compliant = result.is_compliant %}
                {% else %}
                    {% set is_compliant = status.startswith('PRESENT') and not status.startswith('MISSING') %}
                {% endif %}
                <div class="policy-item {% if is_compliant %}pass{% else %}fail{% endif %}" data-compliance="{% if is_compliant %}compliant{% else %}non-compliant{% endif %}">
                    <div class="policy-status-banner {% if is_compliant %}pass{% else %}fail{% endif %}">
                        {% if is_compliant %}✅ COMPLIANT{% else %}❌ NON-COMPLIANT{% endif %}
                    </div>
                    <h4>{{ result.check_id }} - {{ result.requirement_name }}</h4>
                    {% if result.description %}
                    <p class="policy-description"><em>{{ result.description }}</em></p>
                    {% endif %}
                    <div class="policy-details {% if is_compliant %}pass{% else %}fail{% endif %}">
                        <p><strong>Status:</strong> <span class="status-text {% if is_compliant %}pass{% else %}fail{% endif %}">{{ result.status }}</span></p>
                        <p><strong>Policy Found:</strong> {{ result.found }}</p>
                        {% if result.expected_value is defined %}
                        <p><strong>Expected Configuration:</strong> {{ result.expected_value }}</p>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Anti-Spam Policies -->
        {% if antispam_results %}
        <div class="section-card">
            <div class="section-header">
                <h3>📧 Defender for Office 365 - Anti-Spam Policies</h3>
            </div>
            <div class="section-content">
                {% for result in antispam_results %}
                {% set status = result.status %}
                <div class="policy-item {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">
                    <div class="policy-status-banner {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">
                        {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}✅ COMPLIANT{% else %}❌ NON-COMPLIANT{% endif %}
                    </div>
                    <h4>{{ result.check_id }} - {{ result.requirement_name }}</h4>
                    <div class="policy-details {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">
                        <p><strong>Status:</strong> <span class="status-text {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">{{ result.status }}</span></p>
                        <p><strong>Policy Found:</strong> {{ result.found }}</p>
                        {% if result.expected_value is defined %}
                        <p><strong>Expected Value:</strong> 
                            {% if result.expected_value is iterable and result.expected_value is not string %}
                                {% if result.expected_value|length > 5 %}
                                    <div class="expected-value-container">
                                        <span class="expected-value-truncated">[{{ result.expected_value[:5]|join(', ') }}, ... ({{ result.expected_value|length - 5 }} more)] 
                                            <button class="expand-btn" onclick="toggleExpectedValue(this)">Show More</button>
                                        </span>
                                        <span class="expected-value-full" style="display: none;">
                                            [{{ result.expected_value|join(', ') }}] 
                                            <button class="collapse-btn" onclick="toggleExpectedValue(this)">Show Less</button>
                                        </span>
                                    </div>
                                {% else %}
                                    [{{ result.expected_value|join(', ') }}]
                                {% endif %}
                            {% else %}
                                {{ result.expected_value }}
                            {% endif %}
                        </p>
                        {% endif %}
                        {% if result.policy_results %}
                        <div class="policy-breakdown">
                            <h4>Policy Details:</h4>
                            <ul>
                            {% for policy_result in result.policy_results %}
                                <li>{{ policy_result.policy_name }}: 
                                    {% if policy_result.is_compliant %}
                                        <span style="color: var(--success-color);">✓ COMPLIANT</span>
                                    {% else %}
                                        <span style="color: var(--danger-color);">✗ NON-COMPLIANT</span>
                                    {% endif %}
                                    {% if policy_result.current_value is defined %}
                                        (Current: {{ policy_result.current_value }})
                                    {% endif %}
                                </li>
                            {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Anti-Phishing Policies -->
        {% if antiphishing_results %}
        <div class="section-card">
            <div class="section-header">
                <h3>🎣 Defender for Office 365 - Anti-Phishing Policies</h3>
            </div>
            <div class="section-content">
                {% for result in antiphishing_results %}
                {% set status = result.status %}
                <div class="policy-item {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">
                    <div class="policy-status-banner {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">
                        {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}✅ COMPLIANT{% else %}❌ NON-COMPLIANT{% endif %}
                    </div>
                    <h4>{{ result.check_id }} - {{ result.requirement_name }}</h4>
                    <div class="policy-details {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">
                        <p><strong>Status:</strong> <span class="status-text {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">{{ result.status }}</span></p>
                        <p><strong>Policy Found:</strong> {{ result.found }}</p>
                        {% if result.expected_value is defined %}
                        <p><strong>Expected Value:</strong> 
                            {% if result.expected_value is iterable and result.expected_value is not string %}
                                {% if result.expected_value|length > 5 %}
                                    <div class="expected-value-container">
                                        <span class="expected-value-truncated">[{{ result.expected_value[:5]|join(', ') }}, ... ({{ result.expected_value|length - 5 }} more)] 
                                            <button class="expand-btn" onclick="toggleExpectedValue(this)">Show More</button>
                                        </span>
                                        <span class="expected-value-full" style="display: none;">
                                            [{{ result.expected_value|join(', ') }}] 
                                            <button class="collapse-btn" onclick="toggleExpectedValue(this)">Show Less</button>
                                        </span>
                                    </div>
                                {% else %}
                                    [{{ result.expected_value|join(', ') }}]
                                {% endif %}
                            {% else %}
                                {{ result.expected_value }}
                            {% endif %}
                        </p>
                        {% endif %}
                        {% if result.policy_results %}
                        <div class="policy-breakdown">
                            <h4>Policy Details:</h4>
                            <ul>
                            {% for policy_result in result.policy_results %}
                                <li>{{ policy_result.policy_name }}: 
                                    {% if policy_result.is_compliant %}
                                        <span style="color: var(--success-color);">✓ COMPLIANT</span>
                                    {% else %}
                                        <span style="color: var(--danger-color);">✗ NON-COMPLIANT</span>
                                    {% endif %}
                                    {% if policy_result.current_value is defined %}
                                        (Current: {{ policy_result.current_value }})
                                    {% endif %}
                                </li>
                            {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Anti-Malware Policies -->
        {% if antimalware_results %}
        <div class="section-card">
            <div class="section-header">
                <h3>🦠 Defender for Office 365 - Anti-Malware Policies</h3>
            </div>
            <div class="section-content">
                {% for result in antimalware_results %}
                {% set status = result.status %}
                <div class="policy-item {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">
                    <div class="policy-status-banner {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">
                        {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}✅ COMPLIANT{% else %}❌ NON-COMPLIANT{% endif %}
                    </div>
                    <h4>{{ result.check_id }} - {{ result.requirement_name }}</h4>
                    <div class="policy-details {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">
                        <p><strong>Status:</strong> <span class="status-text {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">{{ result.status }}</span></p>
                        <p><strong>Policy Found:</strong> {{ result.found }}</p>
                        {% if result.expected_value is defined %}
                        <p><strong>Expected Value:</strong> 
                            {% if result.expected_value is iterable and result.expected_value is not string %}
                                {% if result.expected_value|length > 5 %}
                                    <div class="expected-value-container">
                                        <span class="expected-value-truncated">[{{ result.expected_value[:5]|join(', ') }}, ... ({{ result.expected_value|length - 5 }} more)] 
                                            <button class="expand-btn" onclick="toggleExpectedValue(this)">Show More</button>
                                        </span>
                                        <span class="expected-value-full" style="display: none;">
                                            [{{ result.expected_value|join(', ') }}] 
                                            <button class="collapse-btn" onclick="toggleExpectedValue(this)">Show Less</button>
                                        </span>
                                    </div>
                                {% else %}
                                    [{{ result.expected_value|join(', ') }}]
                                {% endif %}
                            {% else %}
                                {{ result.expected_value }}
                            {% endif %}
                        </p>
                        {% endif %}
                        {% if result.policy_results %}
                        <div class="policy-breakdown">
                            <h4>Policy Details:</h4>
                            <ul>
                            {% for policy_result in result.policy_results %}
                                <li>{{ policy_result.policy_name }}: 
                                    {% if policy_result.is_compliant %}
                                        <span style="color: var(--success-color);">✓ COMPLIANT</span>
                                    {% else %}
                                        <span style="color: var(--danger-color);">✗ NON-COMPLIANT</span>
                                    {% endif %}
                                    {% if policy_result.current_value is defined %}
                                        (Current: {{ policy_result.current_value }})
                                    {% endif %}
                                </li>
                            {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Safe Attachments Policies -->
        {% if safeattachments_results %}
        <div class="section-card">
            <div class="section-header">
                <h3>📎 Defender for Office 365 - Safe Attachments Policies</h3>
            </div>
            <div class="section-content">
                {% for result in safeattachments_results %}
                {% set status = result.status %}
                <div class="policy-item {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">
                    <div class="policy-status-banner {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">
                        {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}✅ COMPLIANT{% else %}❌ NON-COMPLIANT{% endif %}
                    </div>
                    <h4>{{ result.check_id }} - {{ result.requirement_name }}</h4>
                    <div class="policy-details {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">
                        <p><strong>Status:</strong> <span class="status-text {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">{{ result.status }}</span></p>
                        <p><strong>Policy Found:</strong> {{ result.found }}</p>
                        {% if result.expected_value is defined %}
                        <p><strong>Expected Value:</strong> 
                            {% if result.expected_value is iterable and result.expected_value is not string %}
                                {% if result.expected_value|length > 5 %}
                                    <div class="expected-value-container">
                                        <span class="expected-value-truncated">[{{ result.expected_value[:5]|join(', ') }}, ... ({{ result.expected_value|length - 5 }} more)] 
                                            <button class="expand-btn" onclick="toggleExpectedValue(this)">Show More</button>
                                        </span>
                                        <span class="expected-value-full" style="display: none;">
                                            [{{ result.expected_value|join(', ') }}] 
                                            <button class="collapse-btn" onclick="toggleExpectedValue(this)">Show Less</button>
                                        </span>
                                    </div>
                                {% else %}
                                    [{{ result.expected_value|join(', ') }}]
                                {% endif %}
                            {% else %}
                                {{ result.expected_value }}
                            {% endif %}
                        </p>
                        {% endif %}
                        {% if result.policy_results %}
                        <div class="policy-breakdown">
                            <h4>Policy Details:</h4>
                            <ul>
                            {% for policy_result in result.policy_results %}
                                <li>{{ policy_result.policy_name }}: 
                                    {% if policy_result.is_compliant %}
                                        <span style="color: var(--success-color);">✓ COMPLIANT</span>
                                    {% else %}
                                        <span style="color: var(--danger-color);">✗ NON-COMPLIANT</span>
                                    {% endif %}
                                    {% if policy_result.current_value is defined %}
                                        (Current: {{ policy_result.current_value }})
                                    {% endif %}
                                </li>
                            {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Safe Links Policies -->
        {% if safelinks_results %}
        <div class="section-card">
            <div class="section-header">
                <h3>🔗 Defender for Office 365 - Safe Links Policies</h3>
            </div>
            <div class="section-content">
                {% for result in safelinks_results %}
                {% set status = result.status %}
                <div class="policy-item {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">
                    <div class="policy-status-banner {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">
                        {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}✅ COMPLIANT{% else %}❌ NON-COMPLIANT{% endif %}
                    </div>
                    <h4>{{ result.check_id }} - {{ result.requirement_name }}</h4>
                    <div class="policy-details {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">
                        <p><strong>Status:</strong> <span class="status-text {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">{{ result.status }}</span></p>
                        <p><strong>Policy Found:</strong> {{ result.found }}</p>
                        {% if result.expected_value is defined %}
                        <p><strong>Expected Value:</strong> 
                            {% if result.expected_value is iterable and result.expected_value is not string %}
                                {% if result.expected_value|length > 5 %}
                                    <div class="expected-value-container">
                                        <span class="expected-value-truncated">[{{ result.expected_value[:5]|join(', ') }}, ... ({{ result.expected_value|length - 5 }} more)] 
                                            <button class="expand-btn" onclick="toggleExpectedValue(this)">Show More</button>
                                        </span>
                                        <span class="expected-value-full" style="display: none;">
                                            [{{ result.expected_value|join(', ') }}] 
                                            <button class="collapse-btn" onclick="toggleExpectedValue(this)">Show Less</button>
                                        </span>
                                    </div>
                                {% else %}
                                    [{{ result.expected_value|join(', ') }}]
                                {% endif %}
                            {% else %}
                                {{ result.expected_value }}
                            {% endif %}
                        </p>
                        {% endif %}
                        {% if result.policy_results %}
                        <div class="policy-breakdown">
                            <h4>Policy Details:</h4>
                            <ul>
                            {% for policy_result in result.policy_results %}
                                <li>{{ policy_result.policy_name }}: 
                                    {% if policy_result.is_compliant %}
                                        <span style="color: var(--success-color);">✓ COMPLIANT</span>
                                    {% else %}
                                        <span style="color: var(--danger-color);">✗ NON-COMPLIANT</span>
                                    {% endif %}
                                    {% if policy_result.current_value is defined %}
                                        (Current: {{ policy_result.current_value }})
                                    {% endif %}
                                </li>
                            {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Exchange Online Configurations -->
        {% if exchangeonline_results %}
        <div class="section-card">
            <div class="section-header">
                <h3>📨 Exchange Online Configurations</h3>
            </div>
            <div class="section-content">
                {% for result in exchangeonline_results %}
                {% set status = result.status %}
                <div class="policy-item {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">
                    <div class="policy-status-banner {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">
                        {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}✅ COMPLIANT{% else %}❌ NON-COMPLIANT{% endif %}
                    </div>
                    <h4>{{ result.check_id }} - {{ result.requirement_name }}</h4>
                    <div class="policy-details {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">
                        <p><strong>Status:</strong> <span class="status-text {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">{{ result.status }}</span></p>
                        <p><strong>Policy Found:</strong> {{ result.found }}</p>
                        {% if result.expected_value is defined %}
                        <p><strong>Expected Value:</strong> 
                            {% if result.expected_value is iterable and result.expected_value is not string %}
                                {% if result.expected_value|length > 5 %}
                                    <div class="expected-value-container">
                                        <span class="expected-value-truncated">[{{ result.expected_value[:5]|join(', ') }}, ... ({{ result.expected_value|length - 5 }} more)] 
                                            <button class="expand-btn" onclick="toggleExpectedValue(this)">Show More</button>
                                        </span>
                                        <span class="expected-value-full" style="display: none;">
                                            [{{ result.expected_value|join(', ') }}] 
                                            <button class="collapse-btn" onclick="toggleExpectedValue(this)">Show Less</button>
                                        </span>
                                    </div>
                                {% else %}
                                    [{{ result.expected_value|join(', ') }}]
                                {% endif %}
                            {% else %}
                                {{ result.expected_value }}
                            {% endif %}
                        </p>
                        {% endif %}
                        {% if result.policy_results %}
                        <div class="policy-breakdown">
                            <h4>Policy Details:</h4>
                            <ul>
                            {% for policy_result in result.policy_results %}
                                <li>{{ policy_result.policy_name }}: 
                                    {% if policy_result.is_compliant %}
                                        <span style="color: var(--success-color);">✓ COMPLIANT</span>
                                    {% else %}
                                        <span style="color: var(--danger-color);">✗ NON-COMPLIANT</span>
                                    {% endif %}
                                    {% if policy_result.current_value is defined %}
                                        (Current: {{ policy_result.current_value }})
                                    {% endif %}
                                </li>
                            {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- DNS Configurations -->
        {% if dns_results %}
        <div class="section-card">
            <div class="section-header">
                <h3>🌐 DNS Security Configurations</h3>
            </div>
            <div class="section-content">
                {% for result in dns_results %}
                {% set status = result.status %}
                {% set is_compliant = result.is_compliant if result.is_compliant is defined else (status.startswith('COMPLIANT') or (result.found and not status.startswith('NON-COMPLIANT') and 'ERROR' not in status)) %}
                <div class="policy-item {% if is_compliant %}pass{% else %}fail{% endif %}">
                    <div class="policy-status-banner {% if is_compliant %}pass{% else %}fail{% endif %}">
                        {% if is_compliant %}✅ COMPLIANT{% else %}❌ NON-COMPLIANT{% endif %}
                    </div>
                    <h4>{{ result.check_id }} - {{ result.requirement_name }}</h4>
                    <div class="policy-details {% if is_compliant %}pass{% else %}fail{% endif %}">
                        <p><strong>Status:</strong> <span class="status-text {% if is_compliant %}pass{% else %}fail{% endif %}">{{ result.status }}</span></p>
                        <p><strong>Configuration Found:</strong> {{ result.found }}</p>
                        {% if result.expected_value is defined %}
                        <p><strong>Expected Configuration:</strong> {{ result.expected_value }}</p>
                        {% endif %}
                        {% if result.current_value is defined and result.current_value %}
                        <p><strong>Current Configuration:</strong> 
                            {% if result.current_value is mapping %}
                                <ul style="margin: 5px 0; padding-left: 20px;">
                                {% for key, value in result.current_value.items() %}
                                    <li><strong>{{ key }}:</strong> {{ value }}</li>
                                {% endfor %}
                                </ul>
                            {% elif result.current_value is iterable and result.current_value is not string %}
                                <ul style="margin: 5px 0; padding-left: 20px;">
                                {% for item in result.current_value %}
                                    <li>{{ item }}</li>
                                {% endfor %}
                                </ul>
                            {% else %}
                                {{ result.current_value }}
                            {% endif %}
                        </p>
                        {% endif %}
                        {% if result.details is defined and result.details %}
                        <div class="policy-breakdown">
                            <h4>DNS Record Details:</h4>
                            {% if result.details.records is defined and result.details.records %}
                            <ul>
                            {% for record in result.details.records %}
                                <li style="font-family: 'Roboto Mono', monospace; font-size: 12px; word-break: break-all;">{{ record }}</li>
                            {% endfor %}
                            </ul>
                            {% endif %}
                            {% if result.details.status is defined %}
                            <p><strong>DNS Status:</strong> {{ result.details.status }}</p>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Defender for Endpoint - Antivirus -->
        {% if antivirus_results %}
        <div class="section-card">
            <div class="section-header">
                <h3>🛡️ Defender for Endpoint - Antivirus Policies</h3>
            </div>
            <div class="section-content">
                {% for result in antivirus_results %}
                {% set status = result.status %}
                <div class="policy-item {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">
                    <div class="policy-status-banner {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">
                        {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}✅ COMPLIANT{% else %}❌ NON-COMPLIANT{% endif %}
                    </div>
                    <h4>{{ result.check_id }} - {{ result.requirement_name }}</h4>
                    <div class="policy-details {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">
                        <p><strong>Configuration Status:</strong> <span class="status-text {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">{{ result.status }}</span></p>
                        <p><strong>Policy Found:</strong> {{ result.found }}</p>
                        {% if result.expected_value is defined %}
                        <p><strong>Expected Value:</strong> 
                            {% if result.expected_value is iterable and result.expected_value is not string %}
                                {% if result.expected_value|length > 5 %}
                                    <div class="expected-value-container">
                                        <span class="expected-value-truncated">[{{ result.expected_value[:5]|join(', ') }}, ... ({{ result.expected_value|length - 5 }} more)] 
                                            <button class="expand-btn" onclick="toggleExpectedValue(this)">Show More</button>
                                        </span>
                                        <span class="expected-value-full" style="display: none;">
                                            [{{ result.expected_value|join(', ') }}] 
                                            <button class="collapse-btn" onclick="toggleExpectedValue(this)">Show Less</button>
                                        </span>
                                    </div>
                                {% else %}
                                    [{{ result.expected_value|join(', ') }}]
                                {% endif %}
                            {% else %}
                                {{ result.expected_value }}
                            {% endif %}
                        </p>
                        {% endif %}
                        {% if result.policy_results %}
                        <div class="policy-breakdown">
                            <h4>Policy Details:</h4>
                            <ul>
                            {% for policy_result in result.policy_results %}
                                <li>{{ policy_result.policy_name }}: 
                                    {% if policy_result.is_compliant %}
                                        <span style="color: var(--success-color);">✓ COMPLIANT</span>
                                    {% else %}
                                        <span style="color: var(--danger-color);">✗ NON-COMPLIANT</span>
                                    {% endif %}
                                    {% if policy_result.current_value is defined %}
                                        (Current: {{ policy_result.current_value }})
                                    {% endif %}
                                </li>
                            {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Defender for Endpoint - Attack Surface Reduction -->
        {% if asr_results %}
        <div class="section-card">
            <div class="section-header">
                <h3>🔒 Defender for Endpoint - Attack Surface Reduction</h3>
            </div>
            <div class="section-content">
                {% for result in asr_results %}
                {% set status = result.status %}
                <div class="policy-item {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">
                    <div class="policy-status-banner {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">
                        {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}✅ COMPLIANT{% else %}❌ NON-COMPLIANT{% endif %}
                    </div>
                    <h4>{{ result.check_id }} - {{ result.requirement_name }}</h4>
                    <div class="policy-details {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">
                        <p><strong>Configuration Status:</strong> <span class="status-text {% if status.startswith('PRESENT') or status.startswith('COMPLIANT') %}pass{% else %}fail{% endif %}">{{ result.status }}</span></p>
                        <p><strong>Policy Found:</strong> {{ result.found }}</p>
                        {% if result.expected_value is defined %}
                        <p><strong>Expected Value:</strong> 
                            {% if result.expected_value is iterable and result.expected_value is not string %}
                                {% if result.expected_value|length > 5 %}
                                    <div class="expected-value-container">
                                        <span class="expected-value-truncated">[{{ result.expected_value[:5]|join(', ') }}, ... ({{ result.expected_value|length - 5 }} more)] 
                                            <button class="expand-btn" onclick="toggleExpectedValue(this)">Show More</button>
                                        </span>
                                        <span class="expected-value-full" style="display: none;">
                                            [{{ result.expected_value|join(', ') }}] 
                                            <button class="collapse-btn" onclick="toggleExpectedValue(this)">Show Less</button>
                                        </span>
                                    </div>
                                {% else %}
                                    [{{ result.expected_value|join(', ') }}]
                                {% endif %}
                            {% else %}
                                {{ result.expected_value }}
                            {% endif %}
                        </p>
                        {% endif %}
                        {% if result.policy_results %}
                        <div class="policy-breakdown">
                            <h4>Policy Details:</h4>
                            <ul>
                            {% for policy_result in result.policy_results %}
                                <li>{{ policy_result.policy_name }}: 
                                    {% if policy_result.is_compliant %}
                                        <span style="color: var(--success-color);">✓ COMPLIANT</span>
                                    {% else %}
                                        <span style="color: var(--danger-color);">✗ NON-COMPLIANT</span>
                                    {% endif %}
                                    {% if policy_result.current_value is defined %}
                                        (Current: {{ policy_result.current_value }})
                                    {% endif %}
                                </li>
                            {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
    
    <script>
        // Toggle Expected Value Display
        function toggleExpectedValue(button) {
            const container = button.closest('.expected-value-container');
            const truncated = container.querySelector('.expected-value-truncated');
            const full = container.querySelector('.expected-value-full');
            
            if (truncated && full) {
                if (truncated.style.display === 'none') {
                    // Show truncated, hide full
                    truncated.style.display = 'inline';
                    full.style.display = 'none';
                } else {
                    // Show full, hide truncated
                    truncated.style.display = 'none';
                    full.style.display = 'inline';
                }
            }
        }

        // Enhanced Compliance Filter System
        class ComplianceFilter {
            constructor() {
                this.init();
            }
            
            init() {
                this.addDataAttributes();
                this.updateCounts();
                this.bindEventListeners();
                this.showAll(); // Start with all items visible
            }
            
            // Add data attributes to all policy items based on their status
            addDataAttributes() {
                const policyItems = document.querySelectorAll('.policy-item');
                const sectionCards = document.querySelectorAll('.section-card');
                
                policyItems.forEach(item => {
                    if (!item.hasAttribute('data-compliance')) {
                        const isCompliant = item.classList.contains('pass');
                        item.setAttribute('data-compliance', isCompliant ? 'compliant' : 'non-compliant');
                    }
                });
                
                // Add data-section attributes to section cards if they don't have them
                sectionCards.forEach((section, index) => {
                    if (!section.hasAttribute('data-section')) {
                        const heading = section.querySelector('.section-header h3');
                        if (heading) {
                            const sectionName = heading.textContent.toLowerCase()
                                .replace(/[^\w\s]/g, '') // Remove special characters
                                .replace(/\s+/g, '-'); // Replace spaces with dashes
                            section.setAttribute('data-section', sectionName);
                        } else {
                            section.setAttribute('data-section', `section-${index}`);
                        }
                    }
                });
            }
            
            // Update the count badges
            updateCounts() {
                const allItems = document.querySelectorAll('.policy-item').length;
                const compliantItems = document.querySelectorAll('.policy-item[data-compliance="compliant"]').length;
                const nonCompliantItems = allItems - compliantItems;
                
                document.getElementById('count-all').textContent = allItems;
                document.getElementById('count-compliant').textContent = compliantItems;
                document.getElementById('count-non-compliant').textContent = nonCompliantItems;
            }
            
            // Bind filter event listeners
            bindEventListeners() {
                const filterInputs = document.querySelectorAll('input[name="compliance-filter"]');
                filterInputs.forEach(input => {
                    input.addEventListener('change', (e) => {
                        const filterValue = e.target.value;
                        this.applyFilter(filterValue);
                    });
                });
            }
            
            // Apply the selected filter
            applyFilter(filterValue) {
                const policyItems = document.querySelectorAll('.policy-item');
                const sectionCards = document.querySelectorAll('.section-card');
                
                // Filter policy items
                policyItems.forEach(item => {
                    const compliance = item.getAttribute('data-compliance');
                    const shouldShow = filterValue === 'all' || compliance === filterValue;
                    
                    if (shouldShow) {
                        item.classList.remove('hidden');
                        item.classList.add('fade-in');
                    } else {
                        item.classList.add('hidden');
                        item.classList.remove('fade-in');
                    }
                });
                
                // Hide sections that have no visible items
                sectionCards.forEach(section => {
                    const visibleItems = section.querySelectorAll('.policy-item:not(.hidden)');
                    if (visibleItems.length === 0 && filterValue !== 'all') {
                        section.classList.add('hidden');
                    } else {
                        section.classList.remove('hidden');
                        section.classList.add('fade-in');
                    }
                });
                
                this.updateFilteredCounts(filterValue);
                this.updateScrollPosition();
            }
            
            // Update counts based on currently visible items
            updateFilteredCounts(activeFilter) {
                const visibleItems = document.querySelectorAll('.policy-item:not(.hidden)');
                const allItems = document.querySelectorAll('.policy-item').length;
                const compliantItems = document.querySelectorAll('.policy-item[data-compliance="compliant"]').length;
                const nonCompliantItems = allItems - compliantItems;
                
                // Update the active filter's count to show visible items
                if (activeFilter === 'all') {
                    document.getElementById('count-all').textContent = allItems;
                } else if (activeFilter === 'compliant') {
                    document.getElementById('count-compliant').textContent = compliantItems;
                } else if (activeFilter === 'non-compliant') {
                    document.getElementById('count-non-compliant').textContent = nonCompliantItems;
                }
            }
            
            // Smooth scroll to first visible item after filtering
            updateScrollPosition() {
                const firstVisibleItem = document.querySelector('.policy-item:not(.hidden)');
                if (firstVisibleItem) {
                    const filterControls = document.querySelector('.filter-controls');
                    const offset = filterControls ? filterControls.offsetHeight + 20 : 20;
                    
                    setTimeout(() => {
                        window.scrollTo({
                            top: firstVisibleItem.offsetTop - offset,
                            behavior: 'smooth'
                        });
                    }, 100);
                }
            }
            
            // Show all items (utility method)
            showAll() {
                this.applyFilter('all');
                document.getElementById('filter-all').checked = true;
            }
            
            // Show only compliant items (utility method)
            showCompliant() {
                this.applyFilter('compliant');
                document.getElementById('filter-compliant').checked = true;
            }
            
            // Show only non-compliant items (utility method)
            showNonCompliant() {
                this.applyFilter('non-compliant');
                document.getElementById('filter-non-compliant').checked = true;
            }
        }
        
        // Initialize the filter system when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            window.complianceFilter = new ComplianceFilter();
            
            // Add keyboard shortcuts for power users
            document.addEventListener('keydown', function(e) {
                // Alt + A = Show All
                if (e.altKey && e.key === 'a') {
                    e.preventDefault();
                    window.complianceFilter.showAll();
                }
                // Alt + C = Show Compliant
                else if (e.altKey && e.key === 'c') {
                    e.preventDefault();
                    window.complianceFilter.showCompliant();
                }
                // Alt + N = Show Non-Compliant
                else if (e.altKey && e.key === 'n') {
                    e.preventDefault();
                    window.complianceFilter.showNonCompliant();
                }
            });
            
            console.log('🔍 Compliance Filter System Initialized');
            console.log('💡 Keyboard shortcuts: Alt+A (All), Alt+C (Compliant), Alt+N (Non-Compliant)');
        });
    </script>
</body>
</html>
